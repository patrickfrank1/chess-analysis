var App={oncreate:function(){analysis[Vars.activeEngines]=ChessBoard("analysisBoard"+(Vars.activeEngines+""),Vars.initBoard),Vars.activeEngines+=1,$("#board").css("width",0.5*(0.86*window.innerHeight)),board=ChessBoard("board",Vars.initBoard)},view:function(){return m(".container-fluid.w-100.ht-100",[m(".row.ht-60",[m("#bw.col-6.w-100.ht-100",[m("#board")]),m("#pgn.col-6",[m(Pgn)])]),m(".row.ht-40",[m(".col-6",[m(Analysis,{num:Vars.activeEngines})]),m(".col-6",[m(Db)])])])}},About={view:function(){return".container.ht-100",[m("h2.lobster.text-center","About Chess Analyis"),m(".row",[m(".col-1"," "),m(".col-10.justify-content-center",[m("span","Hello, I'm Patrick Frank and I've created this page for you to analyse your chess games! Lichess is brilliant for playing, but I did not find any good ressource for analyzing my games, hence I created this tool. Please note that this is only an "),m("strong","alpha version"),m("span"," and you should expect some bugs."),m("br"),m("br"),m("span","The whole application is written in JavaScript and games are saved in your browser (LocalSorage)."),m("br"),m("br"),m("span","For any remarks feel free to contact me."),m("img[src='img/018a.png']"),m("br"),m("br"),m("span","Dependencies"),m("ul",[m("li","Bootstrap(",m("a[href='https://github.com/twbs/bootstrap/blob/v4.0.0/LICENSE']","MIT"),")"),m("li","chessboard.js(",m("a[href='https://github.com/oakmac/chessboardjs/blob/master/LICENSE.md']","MIT"),")"),m("li","Mithril(",m("a[href='https://github.com/MithrilJS/mithril.js/blob/next/LICENSE']","MIT"),")"),m("li","chess.js(",m("a[href='https://github.com/jhlywa/chess.js/blob/master/LICENSE']","BSD 2-Clause"),")"),m("li","JQuery(",m("a[href='https://jquery.org/license/']","MIT"),")"),m("li","stockfish.js(",m("a[href='https://github.com/niklasf/stockfish.js/blob/ddugovic/Copying.txt']","GNU GPLv3.0"),")"),m("li",m("a[href='http://op12no2.me/category/chess/']","Lozza")),m("li","garbochess.js(",m("a[href='https://github.com/glinscott/Garbochess-JS/blob/master/LICENSE']","BSD"),")"),m("li","tomitankChess(",m("a[href='https://github.com/tomitank/tomitankChess/blob/master/LICENSE']","GNU GPLv3.0"),")"),m("li","shortcut.js(",m("a[href='http://www.openjs.com/scripts/events/keyboard_shortcuts/index.php']","BSD"),")")])])])]}};$(window).on("load",function(){m.route(document.getElementById("app"),"/",{"/":App,"/about":About}),$("#ms").append("<div id=\"m1\"></div>"),m.mount(document.getElementById("m1"),overwriteDialog),$("#ms").append("<div id=\"m2\"></div>"),m.mount(document.getElementById("m2"),AutoAnalysis),$("#ms").append("<div id=\"m3\"></div>"),m.mount(document.getElementById("m3"),moveAttrs),$("#ms").append("<div id=\"m4\"></div>"),m.mount(document.getElementById("m4"),Upload)});var c=new Chess,engineStatus=[],engine=[];engine[0]=void 0;var analysis=[],onDragStart=function(u,v){if(!0===c.game_over()||"w"===c.turn()&&-1!==v.search(/^b/)||"b"===c.turn()&&-1!==v.search(/^w/))return!1},onDrop=function(u,v){var g=c.move({from:u,to:v});if(null===g&&(-1<u.search(/7/)&&-1<v.search(/8/)||-1<u.search(/2/)&&-1<v.search(/1/))&&(g=c.move({from:u,to:v,promotion:window.prompt("Promote to Queen:'q', Rook:'r', Bishop:'b' or Knight:'n'?","q")})),null===g)return"snapback";var f=c.history();if(Vars.currGame.gameEmpty()){var b=new Move({san:f[f.length-1],moveIdx:f.length});Vars.currGame.addFirstMove(b),Vars.currMove=b}else{var b=new Move({san:f[f.length-1],parent:Vars.currMove.id,moveIdx:f.length});0==Vars.currMove.nextMove.length?(Vars.currMove.appendMove(b),Vars.currMove=b):void 0===Vars.currMove.nextMove.find(h=>{return h.san==b.san})?(Vars.currMove.appendMove(b),Vars.currMove=b):Vars.currMove=Vars.currMove.nextMove.find(h=>{return h.san==b.san})}},onSnapEnd=function(){Vars.analyzing&&(engine[0].stopEngine(),Vars.analyzing=!0),board.position(c.fen()),Vars.pos=c.fen(),Vars.analyzing&&(engine[0]=new Engine({engine:engineStatus[0].name,pos:Vars.pos,number:0}),engine[0].goInfinite()),m.redraw()},saveEverything=function(){var u="";Vars.db.forEach((v,g,f)=>{var b=JSON.stringify(JSON.decycle(v));u+=b,g+1!=f.length&&(u+="\xA7")}),localStorage.setItem("db",u)},addVariation=function(u){var v=u.split("|"),g=engineStatus[v[1]].variation[v[2]],f=`${engineStatus[v[1]].name}:${engineStatus[v[1]].cp[v[2]]},d=${engineStatus[v[1]].depth}`;Vars.currGame.appendVariation(g,f)},EngineStatus=function(u={}){this.status="running",this.n=0===u.number?0:u.number||100,this.mode=u.mode||"i",this.name=u.engine||"",this.pos=u.pos||"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",this.tmpgame=u.tmpgame||[new Chess],this.multipv=u.multipv||1,this.contempt=u.contempt||20,this.cp=u.cp||[],this.depth=0,this.nodes=0,this.nps=0,this.time=0,this.variation=u.variation||[],this.setStatus=function(v){this.status=v,"a"==this.mode},this.setNodes=function(v){this.nodes=v,"i"==this.mode&&($("#a"+(this.n+"")+" #nodes").text(this.nodes/1e6),"tomitank"==this.name&&$("#a"+(this.n+"")+" #nps").text("~"+(this.nodes/this.time).toFixed(3)))},this.setNps=function(v){this.nps=v,"i"==this.mode&&$("#a"+(this.n+"")+" #nps").text(this.nps/1e3)},this.setTime=function(v){this.time=v,"i"==this.mode&&$("#a"+(this.n+"")+" #time").text(this.time/1e3)},this.setDepth=function(v){this.depth=v,"i"==this.mode&&$("#a"+(this.n+"")+" #depth").text(this.depth)},this.setCp=function(v,g){this.cp[g]=v,"i"==this.mode&&$("#a"+(this.n+"")+" #cp"+(g+"")).html(this.cp[g])},this.setVariation=function(v,g){if(this.variation[g]=v,this.tmpgame[g]=new Chess(this.pos),console.log(this.tmpgame[g].ascii()),"i"==this.mode)var f="<span style='border: blue solid 2px; border-radius: 25%;' id='add|"+this.n+"|"+g+"' onclick='addVariation(this.id)'>+</span>";for(var h,b=0;b<v.length;b++)h=this.tmpgame[g].move(v[b],{sloppy:!0}),null==h&&(h=this.tmpgame[g].move(v[b]),null==h&&(h={san:""},console.log("error parsing move"))),this.variation[g][b]=h.san,"i"==this.mode&&(f+="<span onclick='anaSelect(this.id)' id='v|"+this.n+"|"+g+"|"+b+"'>"+this.variation[g][b]+" </span>");"i"==this.mode&&($("#a"+(this.n+" #pv")+(g+"")).html(f),analysis[this.n].position(this.tmpgame[0].fen()))}},anaSelect=function(u){$("#moves span").removeClass("analysis-select");var v=u.split("|");v=v.map(b=>{return parseInt(b)}),console.log(v);for(var g=0,f=new Chess(engineStatus[v[1]].pos);g<=v[3];)f.move(engineStatus[v[1]].variation[v[2]][g]),g++;analysis[v[1]].position(f.fen()),document.getElementById(u).classList.add("analysis-select")};class Engine{constructor(u={}){if(console.log(u),this.n=u.number,engineStatus[u.number]=new EngineStatus(u),"sf9"==u.engine){var v="object"==typeof WebAssembly&&WebAssembly.validate(Uint8Array.of(0,97,115,109,1,0,0,0));this.engine=new Worker(v?"js/sf9/stockfish.wasm.js":"js/sf9/stockfish.js"),"undefined"!=typeof u.multipv&&this.engine.postMessage("setoption name MultiPV value "+(u.multipv+""))}else"lozza"==u.engine?this.engine=new Worker("js/lozza.js"):"tomitank"==u.engine?this.engine=new Worker("js/tomitankChess.js"):"garbochess"==u.engine&&(this.engine=new Worker("js/garbochess.js"));this.engine.onmessage=function(g,f=u.number){var b=g.data.replace(/\s+/g," ");if("sf9"==engineStatus[f].name||"lozza"==engineStatus[f].name||"tomitank"==engineStatus[f].name){var h=b.split(" ");h.includes("bestmove")&&engineStatus[f].setStatus("terminated"),h.includes("nodes")&&engineStatus[f].setNodes(h[h.findIndex(G=>{return"nodes"==G})+1]),h.includes("nps")&&engineStatus[f].setNps(h[h.findIndex(G=>{return"nps"==G})+1]),h.includes("time")&&engineStatus[f].setTime(h[h.findIndex(G=>{return"time"==G})+1]),h.includes("depth")&&engineStatus[f].setDepth(h[h.findIndex(G=>{return"depth"==G})+1]);for(var M=0;M<engineStatus[f].multipv;M++)if("sf9"==engineStatus[f].name&&-1<h.findIndex((G,I,z)=>{return"multipv"==G&&z[I+1]==M+1})||("lozza"==engineStatus[f].name||"tomitank"==engineStatus[f].name)&&-1<h.findIndex(G=>{return"pv"==G})){if(h.includes("mate")&&"w"==engineStatus[f].pos.split(" ")[1])var y="#"+h[h.findIndex(G=>{return"score"==G})+2];else if(h.includes("mate")&&"b"==engineStatus[f].pos.split(" ")[1])var y="#"+-h[h.findIndex(G=>{return"score"==G})+2];else if(h.includes("cp")&&"w"==engineStatus[f].pos.split(" ")[1])var y=h[h.findIndex(G=>{return"cp"==G})+1]/100;else if(h.includes("cp")&&"b"==engineStatus[f].pos.split(" ")[1])var y=-h[h.findIndex(G=>{return"cp"==G})+1]/100;engineStatus[f].setCp(y,M);var w=h.findIndex(G=>{return"pv"==G}),E=h.filter((G,I)=>{return I>w});engineStatus[f].setVariation(E,M)}}else if("garbochess"==engineStatus[f].name){var h=b.split(/[: ]/);if(console.log(h),engineStatus[f].setTime(Date.now()-Vars.date),h.includes("Nodes")&&engineStatus[f].setNodes(h[h.findIndex(G=>{return"Nodes"==G})+1]),h.includes("NPS")&&engineStatus[f].setNps(h[h.findIndex(G=>{return"NPS"==G})+1]),h.includes("Ply")&&engineStatus[f].setDepth(h[h.findIndex(G=>{return"Ply"==G})+1]),h.includes("Score")&&engineStatus[f].setCp(h[h.findIndex(G=>{return"Score"==G})+1]/100,0),h.includes("pv")&&h.includes("NPS")){var w=h.findIndex(G=>{return"NPS"==G}),E=h.filter((G,I)=>{return I>w+1});engineStatus[f].setVariation(E,0)}}}}goInfinite(){"sf9"==engineStatus[this.n].name||"lozza"==engineStatus[this.n].name?(Vars.analyzing=!0,"terminated"==engineStatus[this.n].status&&(engineStatus[this.n].status="running"),"sf9"==engineStatus[this.n].name&&this.engine.postMessage("setoption name Clear Hash"),this.engine.postMessage("ucinewgame"),this.engine.postMessage("position fen "+engineStatus[this.n].pos),this.engine.postMessage("go infinite")):"tomitank"==engineStatus[this.n].name?(Vars.analyzing=!0,this.engine.postMessage("ucinewgame"),this.engine.postMessage("position fen "+engineStatus[this.n].pos),this.engine.postMessage("go depth 99")):"garbochess"==engineStatus[this.n].name&&(Vars.analyzing=!0,Vars.date=Date.now(),this.engine.postMessage("go"),this.engine.postMessage("position "+engineStatus[this.n].pos),this.engine.postMessage("analyze"))}goDepth(u){("sf9"==engineStatus[this.n].name||"lozza"==engineStatus[this.n].name||"tomitank"==engineStatus[this.n].name)&&("terminated"==engineStatus[this.n].status&&(engineStatus[this.n].status="running"),"sf9"==engineStatus[this.n].name&&this.engine.postMessage("setoption name Clear Hash"),this.engine.postMessage("ucinewgame"),this.engine.postMessage("position fen "+engineStatus[this.n].pos),this.engine.postMessage("go depth "+(u+"")))}goNodes(u){("sf9"==engineStatus[this.n].name||"lozza"==engineStatus[this.n].name)&&("sf9"==engineStatus[this.n].name&&this.engine.postMessage("setoption name Clear Hash"),this.engine.postMessage("ucinewgame"),this.engine.postMessage("position fen "+engineStatus[this.n].pos),this.engine.postMessage("go nodes "+(u+"")))}goTime(u){"sf9"==engineStatus[this.n].name||"lozza"==engineStatus[this.n].name||"tomitank"==engineStatus[this.n].name?("terminated"==engineStatus[this.n].status&&(engineStatus[this.n].status="running"),"sf9"==engineStatus[this.n].name&&this.engine.postMessage("setoption name Clear Hash"),this.engine.postMessage("ucinewgame"),this.engine.postMessage("position fen "+engineStatus[this.n].pos),this.engine.postMessage("go movetime "+(1e3*u+""))):"garbochess"==engineStatus[this.n].name&&(Vars.date=Date.now(),this.engine.postMessage("go"),this.engine.postMessage("position "+engineStatus[this.n].pos),this.engine.postMessage("search "+(1e3*u+"")))}stopEngine(){var u={pos:engineStatus[this.n].pos,cp:engineStatus[this.n].cp,variation:engineStatus[this.n].variation,multipv:engineStatus[this.n].multipv};return this.engine.terminate(),Vars.analyzing=!1,engineStatus[this.n].status="terminated",u}setLines(u){this.engine.postMessage("setoption name MultiPV value "+(u+"")),engineStatus[this.n].multipv=u,$("#a"+(this.n+"")+" #moves").empty();for(var v=0;v<engineStatus[this.n].multipv;v++)engineStatus[this.n].tmpgame[v]=new Chess(engineStatus[this.n].pos),$("<div class='row'><div class='col-2' id='cp"+v+"'></div><div class='col-10' id='pv"+v+"' style='border: 1px solid green;'></div></div>").appendTo("#a"+(this.n+" #moves"))}}class Move{constructor(u={}){this.id=u.id||Date.now(),this.parent=u.parent,this.moveIdx=u.moveIdx||0,this.san=u.san||"",this.comment=u.comment||"",this.moveVal=u.moveVal||"",this.posVal=u.posVal||"","undefined"==typeof u.nextMove?this.nextMove=[]:(this.nextMove=[],u.nextMove.forEach(v=>{this.nextMove.push(new Move(v))}))}setSan(u){this.san=u}setAttrs(u){this.comment=u.comment,this.moveVal=u.moveVal,this.posVal=u.posVal}appendMove(u){"undefined"==typeof this.nextMove?this.nextMove=Array(u):this.nextMove.push(u)}}class Game{constructor(u={}){this.id=u.id||Date.now(),this.white=u.white||"",this.black=u.black||"",this.whiteElo=u.whiteElo||1100,this.blackElo=u.blackElo||1100,this.result=u.result||"*",this.date=u.date||"",this.round=u.round||"",this.event=u.event||"",this.site=u.site||"",this.eco=u.eco||"",this.annotator=u.annotator||"",this.moveTree=void 0==u.moveTree?void 0:new Move(u.moveTree),this.startpos=u.startpos||"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"}changeInfo(u={}){this.white=u.white||this.white,this.black=u.black||this.black,this.whiteElo=u.whiteElo||this.whiteElo,this.blackElo=u.blackElo||this.blackElo,this.result=u.result||this.result,this.date=u.date||this.date,this.round=u.round||this.round,this.event=u.event||this.event,this.site=u.site||this.site,this.annotator=u.annotator||this.annotator}addFirstMove(u){this.moveTree=u}gameEmpty(){return this.moveTree==void 0}findMove(u,v=this.moveTree){if(v.id==u)return v;if(0<v.nextMove.length){for(var f,g=0;g<v.nextMove.length;g++)if(f=this.findMove(u,v.nextMove[g]),void 0!=f)return f}}parentMove(u){return this.findMove(u.parent)}childMove(u){if(0!=u.nextMove.length){if(1==u.nextMove.length)return u.nextMove[0];var v="Select variation: ";u.nextMove.forEach((f,b)=>{v+=b+": "+f.san+", "});var g=window.prompt(v,0);return parseInt(g)<u.nextMove.length?u.nextMove[parseInt(g)]:u.nextMove[0]}}deleteMove(u){var v=this.parentMove(u);if("undefined"==typeof v)return u;if(1==v.nextMove.length)v.nextMove=[];else for(var g=0;g<v.nextMove.length;g++)if(v.nextMove[g].id==u.id){v.nextMove.splice(g,1);break}return v}appendVariation(u,v="",g=Vars.currMove){1<u.length?(g.appendMove(new Move({parent:g.id,id:g.id+3701,moveIdx:g.moveIdx+1,san:u.shift()})),this.appendVariation(u,v,g.nextMove[g.nextMove.length-1])):1==u.length?(g.appendMove(new Move({parent:g.id,id:g.id+3701,moveIdx:g.moveIdx+1,san:u.shift(),comment:v})),this.appendVariation(u,v,g.nextMove[g.nextMove.length-1])):m.redraw()}}class Database{constructor(u={}){this.id=u.id||Date.now(),this.name=u.name||"new Database","undefined"==typeof u.games?this.games=[]:(this.games=[],u.games.forEach(v=>{this.games.push(new Game(v))})),this.selected=u.selected||[]}setName(u){this.name=u}addGame(u){"undefined"==typeof this.games?this.games=[u]:this.games.push(u)}overwrite(u){if("undefined"==typeof this.games)this.addGame(u);else{var v=this.games.findIndex(g=>{return g.id==u.id});-1==v?(this.addGame(u),console.log("Nothing to overwrite. Saving game.")):this.games.splice(v,1,u)}}selectAll(){this.selected=[];for(var u=0;u<this.games.length;u++)this.selected.push(this.games[u].id+"")}deselectAll(){this.selected=[]}toggle(u){-1==this.selected.indexOf(u)?this.selected.push(u):this.selected.splice(this.selected.indexOf(u),1),console.log(this.selected)}load(u){for(var v=0;v<this.games.length;v++)u==this.games[v].id&&(Vars.currGame=this.games[v],Vars.changeBoard({position:Vars.currGame.startpos,onDragStart:onDragStart,onDrop:onDrop,onSnapEnd:onSnapEnd}))}}var initdb,initcurrDb;null==localStorage.getItem("db")||""?initdb=[new Database]:(initdb=localStorage.getItem("db").split("\xA7"),initdb=initdb.map(u=>{return JSON.retrocycle(JSON.parse(u))}),initdb=initdb.map(u=>{return new Database(u)}));var Vars={db:initdb,currMove:void 0,currGame:new Game,currDb:initdb[0],pos:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",analyzing:!1,activeEngines:0,date:Date.now(),processingUpload:!1,initBoard:{position:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",orientation:"white",showNotation:!0,draggable:!0,dropOffBoard:"snapback",pieceTheme:"img/chesspieces/wikipedia/{piece}.png",moveSpeed:200,snapbackSpeed:"fast",snapSpeed:"fast",trashSpeed:50,sparePieces:!1,onDragStart:onDragStart,onDrop:onDrop,onSnapEnd:onSnapEnd},changeBoard:function(u={}){board.destroy,Vars.initBoard={position:u.position||Vars.pos,orientation:u.orientation||"white",showNotation:u.showNotation||!0,draggable:u.draggable||!0,dropOffBoard:u.dropOffBoard||"snapback",pieceTheme:u.pieceTheme||"img/chesspieces/wikipedia/{piece}.png",moveSpeed:u.moveSpeed||200,snapbackSpeed:u.snapbackSpeed||"fast",snapSpeed:u.snapSpeed||"fast",trashSpeed:u.trashSpeed||50,sparePieces:u.sparePieces||!1,onDragStart:u.onDragStart,onDrop:u.onDrop,onSnapEnd:u.onSnapEnd},board=ChessBoard("board",Vars.initBoard),$(window).resize(board.resize)}};0==Vars.db.length&&Vars.db.push(Vars.currDb);var Modal={view:function(u){return m(".modal.fade",{id:u.attrs.id,role:"dialog"},m(".modal-dialog",{class:u.attrs.size,role:"document"},m(".modal-content",[m(".modal-header",u.attrs.header_hidden?{hidden:!0}:u.attrs.header()),m(".modal-body",u.attrs.body_hidden?{hidden:!0}:u.attrs.body()),m(".modal-footer",u.attrs.footer_hidden?{hidden:!0}:u.attrs.footer())])))}},AutoAnalysis={oninit:function(u){u.state.id="auto",u.state.size="modal-lg",u.state.hideModal=function(){$("#"+u.state.id).modal("hide")},u.state.header=function(){return m("h4","Set up auto analysis")},u.state.footer=function(){return m("div",[m("button.btn.btn-danger",{onclick:u.state.hideModal},"Cancel"),m("button.btn.btn-success",{onclick:u.state.autoAnalyse},"Analyse")])},u.state.body=function(){if("undefined"==typeof Vars.currGame.moveTree)return m("span","No moves available.");if("undefined"!=typeof Vars.currGame.moveTree){for(var v=[],g=Vars.currGame.moveTree;0<g.nextMove.length;){var f=parseInt(1+Math.floor(g.moveIdx/2)),b=1==g.moveIdx%2?f+". "+g.san:f-1+"... "+g.san;v.push({id:g.id,idx:b,moveIdx:g.moveIdx}),g=g.nextMove[0]}return m("form",[m("h5","Engine setup"),m(".form-row",[m(".form-group.col-4",[m("label[for='anaEng']","Engine"),m("select.form-control[id='anaEng']",[m("option[value='sf9']","Stockfish 9"),m("option[value='lozza']","Lozza 1.6"),m("option[value='tomitank']","Tomitank")])]),m(".form-group.col-4",[m(".col[data-placement='top'][data-toggle='tooltip'][title='Maximum of alternative variations to add for one move.']",m("label[for='altVar']","Maximum variations")),m("select.form-control[id='anaVar'][disabled='true']",[m("option[value='1']","1"),m("option[value='2']","2"),m("option[value='3']","3")])]),m(".form-group.col-4",[m(".col[data-placement='top'][data-toggle='tooltip'][title='If played move has an evaluation difference greater than this threshold, variation will be added.']",m("label[for='cp']","Delta centipawns")),m("input.form-control[id='cp'][max='100'][min='1'][type='number'][value='33']")])]),m(".form-row",[m(".form-group.col-4",[m("label[for='searchType']","Search type"),m("select.custom-select[id='searchType']",[m("option[value='depth']","depth"),m("option[value='time']","time[sec]"),m("option[value='nodes'][disabled='true']","nodes[MNodes]")])]),m(".form-group.col-4",[m("label[for='searchLimit']","Search limit"),m("input.form-control[id='searchLimit'][max='100'][min='1'][type='number'][value='20']")])]),m("hr"),m("h5","Game setup (Currently selected game to be analysed)"),m(".form-row",[m(".form-group.col-6",[m("label[for='startMove']","Start move"),m("select.form-control[id='startMove']",[v.map(h=>{return m("option",{value:h.id+"|"+h.moveIdx},h.idx)})])]),m(".form-group.col-6",[m("label[for='endMove']","End move"),m("select.form-control[id='endMove']",[v.map(h=>{return m("option",{value:h.id+"|"+h.moveIdx},h.idx)})])])]),m(".form-row",[m(".form-group.col-4",[m("label","Before analysis"),m(".input-group",[m(".input-group-prepend",m("span.input-group-text","Strip comments")),m(".input-group-append",m(".input-group-text",m("input[aria-label='strip comments'][id='stripComments'][type='checkbox'][disabled='true']")))])]),m(".form-group.col-4",[m("label","Before analysis"),m(".input-group",[m(".input-group-prepend",m("span.input-group-text","Strip variations")),m(".input-group-append",m(".input-group-text",m("input[aria-label='strip comments'][id='stripVariations'][type='checkbox'][disabled='true']")))])]),m(".form-group.col-4",[m("label","During analysis"),m(".input-group",[m(".input-group-prepend",m("span.input-group-text","Add comments")),m(".input-group-append",m(".input-group-text",m("input[aria-label='strip comments'][id='addComments'][type='checkbox'][checked='true']")))])])])])}},u.state.autoAnalyse=function(){var v=$("#anaEng option:selected").val(),g=$("#cp").val()/100,f=$("#searchType option:selected").val(),b=$("#searchLimit").val(),h=$("#startMove option:selected").val().split("|")[0],M=$("#endMove option:selected").val().split("|")[0],y=$("#endMove option:selected").val().split("|")[1]-$("#startMove option:selected").val().split("|")[1];console.log(y);var w=10,E=$("#stripComments").prop("checked"),G=$("#stripVariations").prop("checked"),I=$("#addComments").prop("checked");"sf9"==v?engine[w]=new Engine({number:w,engine:"sf9",mode:"a"}):"lozza"==v?engine[w]=new Engine({number:w,engine:"lozza",mode:"a"}):"tomitank"==v&&(engine[w]=new Engine({number:w,engine:"tomitank",mode:"a"}));var z=new Game(Vars.currGame),D=new Chess(z.startpos),S=z.moveTree;for(D.move(z.moveTree.san);S.id!=h;)S=S.nextMove[0],D.move(S.san);S=S.nextMove[0],D.move(S.san),$("#auto").modal("hide");var B=T=>new Promise(P=>setTimeout(P,T));(async function(){var T=0;engineStatus[w].pos=D.fen(),"depth"==f?engine[w].goDepth(b):"time"==f&&engine[w].goTime(b);for(var P=!0;P;)await B(1e3),P="running"==engineStatus[w].status;var V=engineStatus[w].cp[0],A=engineStatus[w].variation[0];for(S=S.nextMove[0],D.move(S.san);S.id!=M;){engineStatus[w].pos=D.fen(),console.log(`${100*(T/y)}% analysed`),$("#autoProgress").css("width",100-Math.floor(100*(++T/y))+"%"),"depth"==f?engine[w].goDepth(b):"time"==f&&engine[w].goTime(b);for(var P=!0;P;)await B(1e3),P="running"==engineStatus[w].status;if(console.log("last evaluation - threshold: "+(V-g+"")),console.log("current evaluation: "+(engineStatus[w].cp[0]+"")),"w"==engineStatus[w].pos.split(" ")[1]?console.log("white to move, analyse for black"):console.log("black to move, analyse for white"),"w"==engineStatus[w].pos.split(" ")[1]&&V+g<engineStatus[w].cp[0]){if(I){var N=`${engineStatus[w].name}:${V},d=${engineStatus[w].depth}`;z.appendVariation(A,N,z.parentMove(S))}else z.appendVariation(A,N,z.parentMove(S));}else if("b"==engineStatus[w].pos.split(" ")[1]&&V-g>engineStatus[w].cp[0])if(I){var N=`${engineStatus[w].name}:${V},d=${engineStatus[w].depth}`;z.appendVariation(A,N,z.parentMove(S))}else z.appendVariation(A,N,z.parentMove(S));V=engineStatus[w].cp[0],A=engineStatus[w].variation[0],S=S.nextMove[0],D.move(S.san)}Vars.currGame.moveTree=z.moveTree,console.log(z),"sf9"==v?engine[w]=new Engine({number:w,engine:"sf9",mode:"i"}):"lozza"==v?engine[w]=new Engine({number:w,engine:"lozza",mode:"i"}):"tomitank"==v&&(engine[w]=new Engine({number:w,engine:"tomitank",mode:"i"})),m.redraw()})()}},view:function(u){return m(Modal,{id:u.state.id,size:u.state.size,header:u.state.header,body:u.state.body,footer:u.state.footer,header_hidden:!1,body_hidden:!1,footer_hidden:!1})}},Upload={oninit:function(u){u.state.id="modalupload",u.state.size="modal-lg",u.state.hideModal=function(){$("#"+u.state.id).modal("hide")},u.state.header=function(){return m("div","Upload pgn")},u.state.body=function(){return m(".container-fluid",[m(".alert.alert-warning.alert-dismissible.fade.show[role='alert']",[m("strong","Warning!"),m("span"," Uploading more than ~50 games will probably crash your browser. This feature is still work in progress. Works with pgn files only."),m("button.close[data-dismiss='alert'][aria-label='close']",m("span[aria-hidden='true']",m.trust("&times;")))]),m(".row",m(".col",m("form.form-inline",[m(".input-group",m(".custom-file",[m("label.custom-file-label[for='file'][id='filename']","Choose file"),m("input.custom-file-input[id='file'][type='file']",{onchange:function(){$("#filename").text("undefined"==typeof document.getElementById("file").files[0]?"Choose file":document.getElementById("file").files[0].name)}})])),m(".input-group",[m(".input-group-prepend",m("span.input-group-text","Strip comments")),m(".input-group-append",m(".input-group-text",m("input[aria-label='strip comments'][id='comments'][type='checkbox'][checked='checked']")))]),m(".input-group",[m(".input-group-prepend",m("span.input-group-text","Strip variations")),m(".input-group-append",m(".input-group-text",m("input[aria-label='strip variations'][id='variations'][type='checkbox'][checked='checked']")))])])))])},u.state.footer=function(){return m("div",[m("button.btn.btn-danger",{onclick:u.state.hideModal},"Close"),m("button.btn.btn-success",{onclick:importGames},"Upload")])}},view:function(u){return m(Modal,{id:u.state.id,size:u.state.size,header:u.state.header,body:u.state.body,footer:u.state.footer,header_hidden:!1,body_hidden:!1,footer_hidden:!1})}},moveAttrs={oninit:function(u){u.state.id="modal1",u.state.size="modal-lg",u.state.hideModal=function(){$("#"+u.state.id).modal("hide")},u.state.header=function(){if("undefined"!=typeof Vars.currMove){var v=parseInt(1+Math.floor(Vars.currMove.moveIdx/2)),g=1==Vars.currMove.moveIdx%2?v+". "+Vars.currMove.san:v-1+""+"... "+Vars.currMove.san;return m("div","Change Move Attributes for move "+g)}return m("div","no move")},u.state.changeAttrs=function(){Vars.currMove.setAttrs({comment:$("#comment").val(),moveVal:$("#moveval option:selected").val(),posVal:$("#posval option:selected").val()}),$("#"+u.state.id).modal("hide")},u.state.body=function(){return"undefined"==typeof Vars.currMove?m("span","Not available."):m("form",[m(".form-group.form-row",[m("label[for='comment']","Comment"),m("textarea.form-control[id='comment'][rows='3']",Vars.currMove.comment)]),m(".form-row",[m(".form-group.col",[m("label[for='moveval']","Move Attribute"),m("select.form-control[id='moveval']",[m("option[value='!!']",{selected:"!!"==Vars.currMove.moveVal},"!! (Brilliant move)"),m("option[value='!']",{selected:"!"==Vars.currMove.moveVal},"! (Strong move)"),m("option[value='!?']",{selected:"!?"==Vars.currMove.moveVal},"!? (Interesting move)"),m("option[value='?!']",{selected:"?!"==Vars.currMove.moveVal},"?! (Questionable move)"),m("option[value='?']",{selected:"?"==Vars.currMove.moveVal},"? (Mistake)"),m("option[value='??']",{selected:"??"==Vars.currMove.moveVal},"?? (Blunder)"),m("option[value='&#x25A1;']",{selected:"&#x25A1;"==Vars.currMove.moveVal},[m.trust("&#x25A1;")," (Only move)"]),m("option[value='']",{selected:""==Vars.currMove.moveVal},"(None)")])]),m(".form-group.col",[m("label[for='posval']","Position Attribute"),m("select.form-control[id='posval']",{selected:"&#xFF0D;"==Vars.currMove.posVal},[m("option[value='+&#xFF0D;']",["+",m.trust("&#xFF0D;")," (White wins)"]),m("option[value='&#xB1;']",{selected:"&#xB1;"==Vars.currMove.posVal},[m.trust("&#xB1;")," (Advantage for white)"]),m("option[value='&#x2A72;']",{selected:"&#x2A72;"==Vars.currMove.posVal},[m.trust("&#x2A72;")," (Small advantage for white)"]),m("option[value='=']",{selected:"="==Vars.currMove.posVal},"= (Equal position)"),m("option[value='&#x2A71;']",{selected:"&#x2A71;"==Vars.currMove.posVal},[m.trust("&#x2A71;")," (Small advantage for black)"]),m("option[value='&#x2213;']",{selected:"&#x2213;"==Vars.currMove.posVal},[m.trust("&#x2213;"),"  (Advantage for black)"]),m("option[value='&#xFF0D;+']",{selected:"&#xFF0D;"==Vars.currMove.posVal},[m.trust("&#xFF0D;"),"+ (Black wins)"]),m("option[value='&#x221E;']",{selected:"&#x221E;"==Vars.currMove.posVal},[m.trust("&#x221E;")," (Unclear position)"]),m("option[value='=/&#x221E;']",{selected:"&#x221E;"==Vars.currMove.posVal},["=/",m.trust("&#x221E;")," (Compensation)"]),m("option[value='&#x2191;']",{selected:"&#x2191;"==Vars.currMove.posVal},[m.trust("&#x2191;")," (Initiative)"]),m("option[value='']",{selected:""==Vars.currMove.posVal},"(None)")])])])])},u.state.footer=function(){return m("div",[m("button.btn.btn-danger",{onclick:u.state.hideModal},"Cancel"),m("button.btn.btn-success",{onclick:u.state.changeAttrs},"Save")])}},view:function(u){return m(Modal,{id:u.state.id,size:u.state.size,header:u.state.header,body:u.state.body,footer:u.state.footer,header_hidden:!1,body_hidden:!1,footer_hidden:!1})}},saveDialog={oninit:function(u){u.state.id=u.attrs.id,u.state.size="modal-lg",u.state.hideModal=function(){$("#"+u.state.id).modal("hide")},u.state.header=function(){return m("div","Enter game information to be saved")},u.state.footer=function(){return m(".form-group.form-inline",[m("button.btn.btn-danger",{onclick:u.state.hideModal},"Cancel"),m(".input-group",[m(".input-group-prepend",m("button.btn.btn-success.ml-2[type='button']",{onclick:u.attrs.saveChanges},u.attrs.btnText)),m("select.form-control",{id:"selectDb"+u.state.id},[Vars.db.map(v=>{return m("option",{value:v.id,selected:!(Vars.currDb.id!=v.id)},v.name)})])])])},u.state.body=function(){return m("form",[m("h4","Personal Information"),m(".form-row",[m(".form-group.col-8",[m("label[for='nameWhite']","Name White"),m("input.form-control[placeholder='Mustermann, Max'][type='text']",{id:"nameWhite"+u.state.id,value:Vars.currGame.white})]),m(".form-group.col-4",[m("label[for='eloWhite']","Elo White"),m("input.form-control[max='3500'][min='600'][type='number'][placeholder='1100']",{id:"eloWhite"+u.state.id,value:Vars.currGame.whiteElo})])]),m(".form-row",[m(".form-group.col-8",[m("label[for='nameBlack']","Name Black"),m("input.form-control[placeholder='Doe, John'][type='text']",{id:"nameBlack"+u.state.id,value:Vars.currGame.black})]),m(".form-group.col-4",[m("label[for='eloBlack']","Elo Black"),m("input.form-control[max='3500'][min='600'][type='number'][placeholder='1100']",{id:"eloBlack"+u.state.id,value:Vars.currGame.blackElo})])]),m("hr"),m("h4","Match Information"),m(".form-row",[m(".form-group.col-6",[m("label[for='event']","Event"),m("input.form-control[placeholder='Event Name'][type='text']",{id:"event"+u.state.id,value:Vars.currGame.event})]),m(".form-group.col-3",[m("label[for='round']","Round"),m("input.form-control[type='number'][value='1'][min='1']",{id:"round"+u.state.id,value:Vars.currGame.round})]),m(".form-group.col-3",[m("label[for='date']","Date"),m("input.form-control[type='date']",{id:"date"+u.state.id,value:Vars.currGame.date})])]),m(".form-row",[m(".form-group.col-6",[m("label[for='site']","Site"),m("input.form-control[placeholder='Site'][type='text']",{id:"site"+u.state.id,value:Vars.currGame.site})]),m(".form-group.col-3",[m("label[for='annotator']","Annotator"),m("input.form-control[placeholder='Annotator'][type='text']",{id:"annotator"+u.state.id,value:Vars.currGame.annotator})]),m(".form-group.col-3",[m("label[for='result']","Result"),m("select.form-control",{id:"result"+u.state.id},[m("option[value='*']",{selected:!("*"!=Vars.currGame.result)},"*"),m("option[value='1-0']",{selected:!("1-0"!=Vars.currGame.result)},"1 - 0"),m("option[value='0-1']",{selected:!("0-1"!=Vars.currGame.result)},"0 - 1"),m("option[value='1/2-1/2']",{selected:!("1/2-1/2"!=Vars.currGame.result)},"1/2 - 1/2")])])])])}},view:function(u){return m(Modal,{id:u.state.id,size:u.state.size,header:u.state.header,body:u.state.body,footer:u.state.footer,header_hidden:!1,body_hidden:!1,footer_hidden:!1})}},overwriteDialog={oninit:function(u){u.state.id="modal3",u.state.btnText="Save in",u.state.overwrite=function(){var v={white:$("#nameWhite"+u.state.id).val(),black:$("#nameBlack"+u.state.id).val(),whiteElo:$("#eloWhite"+u.state.id).val(),blackElo:$("#eloBlack"+u.state.id).val(),result:$("#result"+u.state.id+" option:selected").val(),date:$("#date"+u.state.id).val(),round:$("#round"+u.state.id).val(),event:$("#event"+u.state.id).val(),site:$("#site"+u.state.id).val(),annotator:$("#annotator"+u.state.id).val()};Vars.currGame.changeInfo(v);var g=Vars.db.findIndex(f=>{return f.id==$("#selectDb"+u.state.id+" option:selected").val()});Vars.db[g].overwrite(Vars.currGame),saveEverything(),m.redraw(),$("#modal3").modal("hide")}},view:function(u){return m(saveDialog,{id:u.state.id,saveChanges:u.state.overwrite,btnText:u.state.btnText})}},Pgn={oninit:function(u){u.state.a=[],u.state.selectMove=function(v){Vars.analyzing&&(engine[0].stopEngine(),Vars.analyzing=!0),Vars.currMove=Vars.currGame.findMove(v),console.log(Vars.currMove);for(var g=Vars.currMove,f=[];g.id!=Vars.currGame.moveTree.id;)f.unshift(g),g=Vars.currGame.parentMove(g);f.unshift(g),g=Vars.currGame.parentMove(g),console.log(f),c=new Chess(Vars.currGame.startpos),f.forEach(function(b){c.move(b.san)}),board.position(c.fen()),Vars.pos=c.fen(),Vars.analyzing&&(engine[0]=new Engine({engine:engineStatus[0].name,pos:Vars.pos,number:0}),engine[0].goInfinite())},u.state.setFen=function(v){var g=new Chess;g.load(v)?(Vars.pos=v,c=new Chess(Vars.pos),Vars.currGame=new Game({startpos:Vars.pos}),board.position(c.fen())):console.log("Invalid fen string")},u.state.formatMove=function(v,g){var f=parseInt(1+Math.floor(v.moveIdx/2)),b=1==v.moveIdx%2?f+". "+v.san+" ":v.san+" ",h="undefined"==typeof Vars.currMove?"v"+g:v.id==Vars.currMove.id?"selected v"+g:"v"+g;return m("span",{id:v.id,onclick:m.withAttr("id",u.state.selectMove),ondblclick:function(){return $("#modal1").modal("show")},class:h},[m("span",b),""==v.moveVal?null:m("span.moveVal",m.trust(v.moveVal)),""==v.posVal?null:m("span.posVal",m.trust(v.posVal)),""==v.comment?null:m("span.comment",m.trust(v.comment))])},u.state.consumeMoves=function(v,g,f=[],b=!1){b||u.state.a.push(u.state.formatMove(v,g)),0==v.nextMove.length?u.state.a.push(m("br")):1==v.nextMove.length?u.state.consumeMoves(v.nextMove[0],g,f):v.nextMove.forEach((h,M,y)=>{0==M?(u.state.a.push(u.state.formatMove(h,g)),u.state.a.push(m("br"))):M==y.length-1?(u.state.consumeMoves(h,g+1,f),u.state.consumeMoves(y[0],g,f,!0)):u.state.consumeMoves(h,g+1,f)})}},view:function(u){return"undefined"!=typeof Vars.currGame.moveTree&&(u.state.a=[],u.state.consumeMoves(Vars.currGame.moveTree,0)),m("div",[m(".input-group.input-group-sm",[m(".input-group-prepend",m("span.input-group-text","FEN")),m("input#fen.form-control[type='text']",{value:Vars.pos,onchange:m.withAttr("value",u.state.setFen)})]),m("div",[m("span",Vars.currGame.white),m("span","("+Vars.currGame.whiteElo+")"),m("span"," vs. "),m("span",Vars.currGame.black),m("span","("+Vars.currGame.blackElo+")"),m("span",Vars.currGame.result),m("br"),m("span",Vars.currGame.event),m("span","["+Vars.currGame.site+"]"),m("span","Round "+Vars.currGame.round),m("span","played on "+Vars.currGame.date),m("br"),m("span","Annotator: "+Vars.currGame.annotator)]),m("div.pgn",["undefined"==typeof Vars.currGame.moveTree?m("div","waiting for moves"):m("div",[m("div","["+Vars.currGame.startpos+"]"),m("br"),u.state.a.map(v=>{return v})])]),m(".btn-toolbar[aria-label='PGN Toolbar'][role='toolbar']",[m(".btn-group.mr-1[aria-label='Move'][role='group']",[m("button.btn.btn-secondary[title='delete this and following moves'][type='button']",{onclick:"undefined"==typeof Vars.currGame.moveTree?"":undo},m.trust("&#x21E4;")),m("button.btn.btn-secondary[title='move back'][type='button']",{onclick:"undefined"==typeof Vars.currGame.moveTree?"":back},m("strong",m.trust("&#x2190;"))),m("button.btn.btn-secondary[title='move forward'][type='button']",{onclick:"undefined"==typeof Vars.currGame.moveTree?"":forward},m("strong",m.trust("&#x2192;"))),m("button.btn.btn-secondary[title='promote variation'][type='button']",{onclick:"undefined"==typeof Vars.currGame.moveTree?"":promote},m.trust("&#x2B06;")),m("button.btn.btn-secondary[title='delete variation'][type='button']",{onclick:"undefined"==typeof Vars.currGame.moveTree?"":deleteVariation},m.trust("&#x274E;"))]),m(".btn-group[aria-label='Game'][role='group']",[m("button.btn.btn-secondary[title='new game'][type='button']",{onclick:newgame},m.trust("&#x25A9;")),m("button#fromBoard.btn.btn-secondary[title='set up board'][type='button']",{onclick:fromboard},m.trust("&#x265E;")),m("button.btn.btn-secondary[title='save'][type='button']",{onclick:function(){return $("#modal3").modal("show")}},[m("span",m.trust("&#x1F5AB;"))]),"undefined"==typeof engineStatus[10]||"i"==engineStatus[10].mode?m("button.btn.btn-secondary[title='auto analysis'][type='button'][style='width:110px;']",{onclick:function(){return $("#auto").modal("show")}},[m("span",m.trust("&#x1F697;"))]):m("button.btn.btn-secondary",{onclick:function(){return window.alert("Cannot abort at the moment. You can close the browser tab, however you will lose all progress.")}},m(".progress.progress-grad",m("#autoProgress.progress-bar.ml-auto.progress-hide[role='progressbar']",{style:"width:100%"},m("span",m.trust("&#x1F697;")))))])])])}},Db={oninit:function(u){u.state.selectDb=function(){var v=Vars.db.findIndex(g=>{return g.id==$("#chooseDb option:selected").val()});Vars.currDb=Vars.db[v]},u.state.toggleGame=function(v){Vars.currDb.toggle(v),saveEverything()},u.state.loadGame=function(v){Vars.currDb.load(v)},u.state.renameDatabase=function(){var v=window.prompt("Choose a name for the current database.","New Database");Vars.currDb.setName(v),saveEverything()},u.state.newDatabase=function(){var v=window.prompt("Choose a name for the new database.","New Database");Vars.db.push(new Database({name:v})),saveEverything()},u.state.deleteDatabase=function(){if(0==Vars.db.length)console.log("Nothing to delete.");else if(1==Vars.db.length)Vars.db=[],saveEverything();else{var v=Vars.db.findIndex(g=>{return g.id==Vars.currDb.id});Vars.db.splice(v,1),Vars.currDb=Vars.db[v-1]||new Database,saveEverything()}},u.state.selectAllGames=function(){Vars.currDb.selectAll(),saveEverything()},u.state.deselectAllGames=function(){Vars.currDb.deselectAll(),saveEverything()},u.state.deleteGames=function(){console.log("deleting"),Vars.currDb.games=Vars.currDb.games.filter(v=>{return-1==Vars.currDb.selected.indexOf(v.id+"")}),Vars.currDb.selected=[],saveEverything()},u.state.copyTo=function(){var v="Type number of Database you want to copy selected games to!\n";Vars.db.forEach((f,b)=>{v+=b+""+": "+f.name+"\n"});var g=window.prompt(v,0);Vars.currDb.games.forEach(f=>{if(-1!=Vars.currDb.selected.indexOf(f.id+"")){var b=JSON.parse(JSON.stringify(f));b.id=Date.now(),Vars.db[g].addGame(new Game(b))}}),saveEverything()},u.state.moveTo=function(){u.state.copyTo(),u.state.deleteGames()},u.state.a=[],u.state.formatMove=function(v){var f=parseInt(1+Math.floor(v.moveIdx/2)),b=1==v.moveIdx%2?f+". "+v.san+" ":v.san+" ";return""==v.moveVal&&""==v.posVal&&""==v.comment?b:(b+=`{${v.moveVal}|${v.posVal}|${v.comment}} `,b)},u.state.consumeMoves=function(v,g,f=[],b=!1){b||u.state.a.push(u.state.formatMove(v,g)),"undefined"==typeof v.nextMove||(1==v.nextMove.length?u.state.consumeMoves(v.nextMove[0],g,f):v.nextMove.forEach((h,M,y)=>{0==M?u.state.a.push(u.state.formatMove(h,g)):M==y.length-1?(u.state.a.push("( "),u.state.consumeMoves(h,g+1,f),u.state.a.push(") "),u.state.consumeMoves(y[0],g,f,!0)):(u.state.a.push("( "),u.state.consumeMoves(h,g+1,f),u.state.a.push(") "))}))},u.state.exportGame=function(){var g="";Vars.currDb.games.forEach((M,y,w)=>{-1!=Vars.currDb.selected.indexOf(M.id+"")&&(g+=`[Event "${""==M.event?"?":M.event}"]\n`,g+=`[Site "${""==M.site?"?":M.site}"]\n`,g+=`[Date "${""==M.date?"?":M.date}"]\n`,g+=`[Round "${""==M.round?"?":M.round}"]\n`,g+=`[White "${""==M.white?"?":M.white}"]\n`,g+=`[Black "${""==M.black?"?":M.black}"]\n`,g+=`[Result "${M.result}"]\n`,g+=`[WhiteElo "${""==M.whiteElo?"?":M.whiteElo}"]\n`,g+=`[BlackElo "${""==M.blackElo?"?":M.blackElo}"]\n`,g+=`[Annotator "${""==M.annotator?"?":M.annotator}"]\n`,g+=`[ECO "${""==M.eco?"?":M.eco}"]\n`,g+=`[FEN "${M.startpos}"]\n\n`,u.state.a=[],u.state.consumeMoves(M.moveTree,0),g+=u.state.a.join(""),g+=`${M.result}`,y!=w.length-1&&(g+=`\n\n`))});var f=new Blob([g],{type:"text/plain;charset=utf-8"}),b=document.createElement("a");document.body.appendChild(b),b.style="display: none";var h=window.URL.createObjectURL(f);b.href=h,b.download="my-games.pgn",b.click(),window.URL.revokeObjectURL(h)}},view:function(u){return m("div",[m(".input-group.mb-2",[m(".input-group-prepend",m("label.input-group-text[for='chooseDb']","Database")),m("select.custom-select[id='chooseDb']",{onchange:u.state.selectDb},[Vars.db.map(v=>{return m("option",{selected:!(v.id!=Vars.currDb.id),value:v.id},v.name)})])]),m(".table-responsive.db-table",m("table.table.table-sm.table-striped",[m("thead.thead-light",m("tr",[m("th[scope='col']","White"),m("th[scope='col']","Black"),m("th[scope='col']","Result"),m("th[scope='col']","Date"),m("th[scope='col']","Moves")])),m("tbody",[Vars.currDb.games.map(v=>{var g=-1==Vars.currDb.selected.indexOf(v.id+"")?"":"selected-game";return m("tr",{class:g},[m("td",{name:v.id,class:g,onclick:m.withAttr("name",u.state.toggleGame),ondblclick:m.withAttr("name",u.state.loadGame)},v.white),m("td",{name:v.id,class:g,onclick:m.withAttr("name",u.state.toggleGame),ondblclick:m.withAttr("name",u.state.loadGame)},v.black),m("td",{name:v.id,class:g,onclick:m.withAttr("name",u.state.toggleGame),ondblclick:m.withAttr("name",u.state.loadGame)},v.result),m("td",{name:v.id,class:g,onclick:m.withAttr("name",u.state.toggleGame),ondblclick:m.withAttr("name",u.state.loadGame)},v.date),m("td",{name:v.id,class:g,onclick:m.withAttr("name",u.state.toggleGame),ondblclick:m.withAttr("name",u.state.loadGame)},"undefined"==typeof v.moveTree?"no moves":"1. "+v.moveTree.san+"...")])})])])),m(".btn-toolbar[aria-label='DB Toolbar'][role='toolbar']",[m(".btn-group.mr-1[aria-label='Game'][role='group']",[m("button.btn.btn-secondary[title='delete selected games'][type='button']",{onclick:u.state.deleteGames},[m("span",m.trust("&#x1F5AB;")),m("sup",m.trust("&#x274C;"))]),Vars.processingUpload?m("button.btn.btn-secondary",{onclick:function(){return window.alert("Cannot abort at the moment. You can close the browser tab, however you will lose all progress.")}},m(".progress.progress-grad",m("#importProgress.progress-bar.ml-auto.progress-hide[role='progressbar']",{style:"width:100%"},"..."))):m("button.btn.btn-secondary[title='import games'][type='button']",{onclick:function(){$("#modalupload").modal("show")}},[m("span",m.trust("&#x1F5AB;")),m("sup",m.trust("&#x2B06;"))]),m("button.btn.btn-secondary[title='export games'][type='button']",{onclick:u.state.exportGame},[m("span",m.trust("&#x1F5AB;")),m("sup",m.trust("&#x2B07;"))])]),m(".btn-group[aria-label='Database'][role='group']",[m("button.btn.btn-secondary[title='rename database'][type='button']",{onclick:u.state.renameDatabase},[m("span",m.trust("&#x26C1;")),m("sup",m("strong",m.trust("&#x1F5E9;")))]),m("button.btn.btn-secondary[title='new database'][type='button']",{onclick:u.state.newDatabase},[m("span",m.trust("&#x26C1;")),m("sup",m.trust("&#x2795;"))]),m("button.btn.btn-secondary[title='delete database'][type='button']",{onclick:u.state.deleteDatabase},[m("span",m.trust("&#x26C1;")),m("sup",m.trust("&#x274C;"))]),m("button.btn.btn-secondary[title='select all games'][type='button']",{onclick:u.state.selectAllGames},m("span",m.trust("&#x1F5F9;"))),m("button.btn.btn-secondary[title='deselect all games'][type='button']",{onclick:u.state.deselectAllGames},m("span",m.trust("&#x2610;"))),m("button.btn.btn-secondary[title='copy to'][type='button']",{onclick:u.state.copyTo},m("span",m.trust("&#x1F5D0;"))),m("button.btn.btn-secondary[title='move to'][type='button']",{onclick:u.state.moveTo},m("span",m.trust("&#x2398;")))])])])}},Analysis={oninit:function(u){u.state.num=u.attrs.num,engine[u.state.num]=new Engine({engine:"sf9",number:u.state.num,mode:"i"}),u.state.infinite=function(){engineStatus[u.state.num].pos=Vars.pos,engine[u.state.num].goInfinite()},u.state.stop=function(){var v=engine[u.state.num].stopEngine();engine[u.state.num]=new Engine({engine:engineStatus[u.state.num].name,number:u.state.num,pos:v.pos,cp:v.cp,variation:v.variation,multipv:v.multipv})},u.state.action=function(){var v=$("#a"+(u.state.num+"")+" #chooseAnalysis option:selected").val();engineStatus[u.state.num].pos=Vars.pos,"depth"==v?engine[u.state.num].goDepth($("#a"+(u.state.num+"")+" #num").val()):"time"==v?engine[u.state.num].goTime($("#a"+(u.state.num+"")+" #num").val()):"nodes"==v?engine[u.state.num].goNodes($("#a"+(u.state.num+"")+" #num").val()):"setlines"==v&&engine[u.state.num].setLines($("#a"+(u.state.num+"")+" #num").val())},u.state.changeEngine=function(){var v=$("#chooseEngine option:selected").val();!0==Vars.analyzing?(engine[u.state.num].stopEngine(),engine[u.state.num]=new Engine({engine:v,pos:Vars.pos,number:u.state.num,mode:"i"}),engine[u.state.num].setLines(1),engine[u.state.num].goInfinite()):(engine[u.state.num].stopEngine(),engine[u.state.num]=new Engine({engine:v,pos:Vars.pos,number:u.state.num,mode:"i"}))}},view:function(u){return m("div",{id:"a"+(u.state.num+"")},[m(".row.mb-1",m(".col",m("form.form-inline",[m(".input-group.input-group-sm",[m("select.custom-select[id='chooseEngine']",{onchange:u.state.changeEngine},[m("option[value='sf9']","Stockfish 9"),m("option[value='lozza']","Lozza"),m("option[value='tomitank']","Tomitank"),m("option[value='garbochess']","Garbochess")]),m(".input-group-append.mr-1",[m("button.btn.btn-primary[type='button']",{onclick:u.state.infinite},"Go Infinite"),m("button.btn.btn-secondary[type='button']",{onclick:u.state.stop},"Stop")])]),m(".input-group.input-group-sm",[m(".input-group-prepend",m("button.btn.btn-secondary[type='button']",{onclick:u.state.action},"Go")),m("select.custom-select[id='chooseAnalysis']",[m("option[value='depth']",{disabled:!("garbochess"!=$("#chooseEngine option:selected").val())},"depth"),m("option[value='time']",{selected:!("garbochess"!=$("#chooseEngine option:selected").val())},"time"),m("option[value='nodes']",{disabled:!("garbochess"!=$("#chooseEngine option:selected").val())},"nodes"),m("option[value='\u2014\u2014\u2014\u2014\u2014\u2014\u2014'][disabled='disabled']","\u2014\u2014\u2014\u2014\u2014\u2014\u2014"),m("option[value='setlines']",{disabled:"garbochess"==$("#chooseEngine option:selected").val()||"lozza"==$("#chooseEngine option:selected").val()||"tomitank"==$("#chooseEngine option:selected").val()},"# of variations")]),m("input[id='num'][placeholder='0'][type='number']",{style:{width:"5em"}})])]))),m(".row",[m(".col-4",m("div",{id:"analysisBoard"+u.state.num})),m(".col-8",[m(".row.mb-2",[m(".col[data-placement='top'][data-toggle='tooltip'][title='million searched nodes']",[m("span","MNodes "),m("span#nodes")]),m(".col[data-placement='top'][data-toggle='tooltip'][title='thousand searched nodes per second']",[m("span","kNodes/s "),m("span#nps")]),m(".col[data-placement='top'][data-toggle='tooltip'][title='time spent for search']",[m("span","sec "),m("span#time")]),m(".col[data-placement='top'][data-toggle='tooltip'][title='number of searched plies']",[m("span","depth "),m("span#depth")])]),m("#moves",m(".row",m(".col-2#cp0"),m(".col-10#pv0[style='border: 1px solid green;']")))])])])}},undo=function(){Vars.analyzing&&(engine[0].stopEngine(),Vars.analyzing=!0),Vars.currMove=Vars.currGame.deleteMove(Vars.currMove),c.undo(),board.position(c.fen()),Vars.pos=c.fen(),Vars.analyzing&&(engine[0]=new Engine({engine:engineStatus[0].name,pos:Vars.pos,number:0}),engine[0].goInfinite()),m.redraw()},back=function(){(Vars.analyzing&&(engine[0].stopEngine(),Vars.analyzing=!0),void 0!=Vars.currGame.parentMove(Vars.currMove))&&(Vars.currMove=Vars.currGame.parentMove(Vars.currMove),c.undo(),board.position(c.fen()),Vars.pos=c.fen(),Vars.analyzing&&(engine[0]=new Engine({engine:engineStatus[0].name,pos:Vars.pos,number:0}),engine[0].goInfinite()),m.redraw())},forward=function(){(Vars.analyzing&&(engine[0].stopEngine(),Vars.analyzing=!0),0!=Vars.currMove.nextMove.length)&&(Vars.currMove=Vars.currGame.childMove(Vars.currMove),c.move(Vars.currMove.san),board.position(c.fen()),Vars.pos=c.fen(),Vars.analyzing&&(engine[0]=new Engine({engine:engineStatus[0].name,pos:Vars.pos,number:0}),engine[0].goInfinite()),m.redraw())},newgame=function(){!0==window.confirm("Close current game without saving?")&&(Vars.analyzing&&(engine[0].stopEngine(),Vars.analyzing=!0),Vars.currGame=new Game,board.position("start"),c=new Chess,Vars.pos=c.fen(),Vars.analyzing&&(engine[0]=new Engine({engine:engineStatus[0].name,pos:Vars.pos,number:0}),engine[0].goInfinite()),m.redraw())},fromboard=function(){if($("#fromBoard").toggleClass("active"),$("#fromBoard").hasClass("active"))Vars.changeBoard({position:"clear",draggable:!0,dropOffBoard:"trash",trashSpeed:50,sparePieces:!0});else{var u=board.position("fen")+"";u+=" w - - 0 1",console.log(u),Vars.changeBoard({position:u,dropOffBoard:"snapback",pieceTheme:"img/chesspieces/wikipedia/{piece}.png",moveSpeed:200,snapbackSpeed:"fast",snapSpeed:"fast",trashSpeed:50,sparePieces:!1,onDragStart:onDragStart,onDrop:onDrop,onSnapEnd:onSnapEnd}),c=new Chess(u),Vars.pos=u,Vars.currGame=new Game({startpos:u}),m.redraw()}},deleteVariation=function(){for(;Vars.currGame.parentMove(Vars.currMove).nextMove[0]==Vars.currMove;)Vars.currMove=Vars.currGame.deleteMove(Vars.currMove),c.undo();Vars.currMove=Vars.currGame.deleteMove(Vars.currMove),c.undo(),board.position(c.fen()),Vars.pos=c.fen()},promote=function(){for(;Vars.currGame.parentMove(Vars.currMove).nextMove[0]==Vars.currMove;)Vars.currMove=Vars.currGame.parentMove(Vars.currMove);var u=Vars.currMove;Vars.currMove=Vars.currGame.parentMove(Vars.currMove);for(var v=0;v<Vars.currMove.nextMove.length;v++)if(Vars.currMove.nextMove[v].id==u.id){var g=Vars.currMove.nextMove[0];Vars.currMove.nextMove[0]=u,Vars.currMove.nextMove[v]=g,Vars.currMove=Vars.currMove.nextMove[0];break}},importGames=function(){var u;Vars.processingUpload=!0,$("#modalupload").modal("hide"),m.redraw();var v=document.getElementById("file").files[0];v||console.log("No file selected.");var g=new FileReader;g.onload=function(){u=g.result;var b=u.replace(/\r/gm,"").replace(/>/gm,"").replace(/</gm,"").split("\n"),h="",M=Date.now(),y,w=$("#comments").prop("checked"),E=$("#variations").prop("checked");console.log(b),b.forEach((G,I,z)=>{if($("#importProgress").css("width",100-Math.floor(100*(I/z.length))+"%"),console.log(100*(I/z.length)+"%"),/^\[.*\]$/.test(G)&&(0>I-1||!/^\[.*\]$/.test(z[I-1]))&&("undefined"!=typeof y&&Vars.currDb.addGame(y),y=new Game({id:M+I})),/^\[Event \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.event=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[Site \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.site=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[Date \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,"").replace(/-/g,"."),y.date=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[Round \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.round=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[White \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.white=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[Black \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.black=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[Result \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.result=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[Annotator \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.annotator=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[[Ee]loWhite \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.eloWhite=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[[Ee]loBlack \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.eloBlack=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[[Ee][Cc][Oo] \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.eco=D,$("#text").append(I+": "+D+"<br>")}else if(/^\[FEN \".*\"\]$/.test(G)){var D=G.match(/\".*\"/)+"";D=D.replace(/\"/g,""),y.startpos=D,$("#text").append(I+": "+D+"<br>")}else if(/^ ?1\.[^\.\}]{2}((?!1\-0|0\-1|\*|1\/2\-1\/2|0\.5\-0\.5|0,5\-0,5)[^\}])*$/.test(G.replace(/\{[^\{\}]*?\}/g,""))){h="",h+=G+"";for(var S=I;!/^(?:(?!\{(?!.*\})).)*(1\-0|0\-1|\*|1\/2\-1\/2)$/.test(z[S+1]+"");)h+=" "+(z[S+1]+""),++S;h+=" "+(z[S+1]+""),$("#text").append(I+": "+h+"<br>")}else /^1\..+[1\-0|0\-1|\*|1\/2\-1\/2]$/.test(G)?(h=(G+"").replace(/\"/g,""),$("#text").append(I+": "+h+"<br>")):""==G+""&&$("#text").append(I+": new line<br>");if(""!=h)if(h=h.replace(/\(/gm," ( ").replace(/\)/gm," ) ").replace(/\{/gm," { ").replace(/\}/gm," } "),console.log("raw tmpmoves: "+h),console.log(w,E),!w&&!E){var B=h.split(" ");B=B.filter(L=>{return""!=L});var T,P;for(console.log(B),P=""==y.startpos?new Chess:new Chess(y.startpos),k=0;k<B.length;k++)if(console.log(k),null!=P.move(B[k],{sloppy:!0})){console.log("move...");var V=P.history();if(y.gameEmpty()){console.log("add first move");var A=new Move({id:M+k,parent:M+k,san:V[V.length-1],moveIdx:V.length});y.addFirstMove(A),T=A}else{var A=new Move({id:M+k,san:V[V.length-1],parent:T.id,moveIdx:V.length});0==T.nextMove.length?(console.log("add move to main line"),T.appendMove(A),T=A):void 0===T.nextMove.find(L=>{return L.san==A.san})?(console.log("add new variation"),T.appendMove(A),T=A):T=T.nextMove.find(L=>{return L.san==A.san})}}else if("("==B[k])console.log("prepare to add variation, set 1 back"),T=y.parentMove(T),P.undo();else if(")"==B[k]){for(console.log("end variation, got to root then play one");y.parentMove(T).nextMove[0]==T;)T=y.parentMove(T),P.undo();T=y.parentMove(T),P.undo(),T=T.nextMove[0],P.move(T.san)}else if("{"==B[k]){console.log("start comment");for(var N=k,C="";"}"!=B[N];)C+=" "+B[N],N+=1;console.log("end comment"),C+=" "+B[N+1],"undefined"==typeof T||T.setAttrs({comment:C.replace(/\{/,"").replace(/\}/,"")}),k=N}h="",console.log(y)}else if(w&&E){try{for(var F=0;/\{/.test(h);){if(F+=1,15==F)throw"cannot strip comments";h=h.replace(/\{([^\{\}]+)\}/g,"")}for(F=0;/\(/.test(h);){if(F+=1,15==F)throw"cannot strip variations";h=h.replace(/\(([^\(\)]+)\)/g,"")}var B=h.split(" ");B=B.filter(L=>{return""!=L});var T,P;for(console.log(B),P=""==y.startpos?new Chess:new Chess(y.startpos),k=0;k<B.length;k++)if(console.log(k),null!=P.move(B[k],{sloppy:!0})){console.log("move...");var V=P.history();if("undefined"==typeof T){console.log("add first move");var A=new Move({id:M+k,parent:M+k,san:V[V.length-1],moveIdx:V.length});y.addFirstMove(A),T=A}else{var A=new Move({id:M+k,san:V[V.length-1],parent:T.id,moveIdx:V.length});T.appendMove(A),T=A}}}catch(L){console.log(L)}h="",console.log(y)}}),Vars.currDb.addGame(y)},g.readAsText(v,"ISO-8859-15"),Vars.processingUpload=!1,m.redraw()};$(window).on("beforeunload",saveEverything);