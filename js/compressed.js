var c=new Chess,engineStatus=[],engine,onDragStart=function(r,u){if(!0===c.game_over()||'w'===c.turn()&&-1!==u.search(/^b/)||'b'===c.turn()&&-1!==u.search(/^w/))return!1},onDrop=function(r,u){var v=c.move({from:r,to:u});if(null===v&&(-1<r.search(/7/)&&-1<u.search(/8/)||-1<r.search(/2/)&&-1<u.search(/1/))&&(v=c.move({from:r,to:u,promotion:window.prompt('Promote to Queen:\'q\', Rook:\'r\', Bishop:\'b\' or Knight:\'n\'?','q')})),null===v)return'snapback';var g=c.history();if(Vars.currGame.gameEmpty()){var f=new Move({san:g[g.length-1],moveIdx:g.length});Vars.currGame.addFirstMove(f),Vars.currMove=f}else{var f=new Move({san:g[g.length-1],parent:Vars.currMove.id,moveIdx:g.length});0==Vars.currMove.nextMove.length?(Vars.currMove.appendMove(f),Vars.currMove=f):void 0===Vars.currMove.nextMove.find(b=>{return b.san==f.san})?(Vars.currMove.appendMove(f),Vars.currMove=f):Vars.currMove=Vars.currMove.nextMove.find(b=>{return b.san==f.san})}m.redraw()},onSnapEnd=function(){board.position(c.fen()),Vars.pos=c.fen()},saveEverything=function(){var r='';Vars.db.forEach((u,v,g)=>{var f=JSON.stringify(JSON.decycle(u));r+=f,v+1!=g.length&&(r+='\xA7')}),localStorage.setItem('db',r)},EngineStatus=function(r={}){this.status='running',this.name=r.engine||'',this.pos=r.pos||'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq -',this.multipv=r.multipv||1,this.contempt=r.contempt||20,this.cp=[],this.depth=0,this.nodes=0,this.nps=0,this.time=0,this.variation=[]};class Engine{constructor(r={}){if(this.n=r.number,engineStatus[r.number]=new EngineStatus(r),'sf9'==r.engine){var u='object'==typeof WebAssembly&&WebAssembly.validate(Uint8Array.of(0,97,115,109,1,0,0,0));this.engine=new Worker(u?'js/sf9/stockfish.wasm.js':'js/sf9/stockfish.js')}else'lozza'==r.engine?this.engine=new Worker('js/lozza.js'):'tomitank'==r.engine?this.engine=new Worker('js/tomitankChess.js'):'garbochess'==r.engine&&(this.engine=new Worker('js/garbochess.js'));this.engine.onmessage=function(v,g=r.number){console.log(v.data);var f=v.data.replace(/\s+/g,' ');if('sf9'==engineStatus[g].name||'lozza'==engineStatus[g].name||'tomitank'==engineStatus[g].name){var b=f.split(' ');console.log(b),b.includes('nodes')&&(engineStatus[g].nodes=b[b.findIndex(G=>{return'nodes'==G})+1],$('#a'+(g+' #nodes')).text(engineStatus[g].nodes/1e6)),b.includes('nps')&&(engineStatus[g].nps=b[b.findIndex(G=>{return'nps'==G})+1],$('#a'+(g+' #nps')).text(engineStatus[g].nps/1e3)),b.includes('time')&&(engineStatus[g].time=b[b.findIndex(G=>{return'time'==G})+1],$('#a'+(g+' #time')).text(engineStatus[g].time/1e3)),b.includes('depth')&&(engineStatus[g].depth=b[b.findIndex(G=>{return'depth'==G})+1],$('#a'+(g+' #depth')).text(engineStatus[g].depth)),this.cp=this.cp||[],this.variation=this.variation||[];for(var h=0;h<engineStatus[g].multipv;h++){if('sf9'==engineStatus[g].name&&-1<b.findIndex((G,E,D)=>{return'multipv'==G&&D[E+1]==h+1})){var M=b[b.findIndex(G=>{return'cp'==G})+1],y=b.findIndex(G=>{return'pv'==G}),w=b.filter((G,E)=>{return E>y});engineStatus[g].cp[h]=M,'w'==engineStatus[g].pos.split(' ')[1]?$('#a'+(g+' #cp')+(h+'')).html(M/100):'b'==engineStatus[g].pos.split(' ')[1]&&$('#a'+(g+' #cp')+(h+'')).html(-M/100),engineStatus[g].variation[h]=w,$('#a'+(g+' #pv')+(h+'')).html(w.join(' '))}else if(('lozza'==engineStatus[g].name||'tomitank'==engineStatus[g].name)&&-1<b.findIndex(G=>{return'pv'==G})){var M=b[b.findIndex(G=>{return'cp'==G})+1],y=b.findIndex(G=>{return'pv'==G}),w=b.filter((G,E)=>{return E>y});engineStatus[g].cp[h]=M,'w'==engineStatus[g].pos.split(' ')[1]?$('#a'+(g+' #cp')+(h+'')).html(M/100):'b'==engineStatus[g].pos.split(' ')[1]&&$('#a'+(g+' #cp')+(h+'')).html(-M/100),engineStatus[g].variation[h]=w,$('#a'+(g+' #pv')+(h+'')).html(w.join(' '))}'tomitank'==engineStatus[g].name&&$('#a'+(g+' #nps')).text('~'+engineStatus[g].nodes/engineStatus[g].time)}}else if('garbochess'==engineStatus[g].name){var b=f.split(/[: ]/);if(console.log(b),$('#a'+(g+' #time')).text((Date.now()-Vars.date)/1e3),b.includes('Nodes')&&(engineStatus[g].nodes=b[b.findIndex(G=>{return'Nodes'==G})+1],$('#a'+(g+' #nodes')).text(engineStatus[g].nodes/1e6)),b.includes('NPS')&&(engineStatus[g].nps=b[b.findIndex(G=>{return'NPS'==G})+1],$('#a'+(g+' #nps')).text(engineStatus[g].nps/1e3)),b.includes('Ply')&&(engineStatus[g].depth=b[b.findIndex(G=>{return'Ply'==G})+1],$('#a'+(g+' #depth')).text(engineStatus[g].depth)),b.includes('Score')&&(engineStatus[g].cp=b[b.findIndex(G=>{return'Score'==G})+1]/100,$('#a'+(g+' #cp0')).text(engineStatus[g].cp)),b.includes('pv')&&b.includes('NPS')){var y=b.findIndex(G=>{return'NPS'==G}),w=b.filter((G,E)=>{return E>y+1});engineStatus[g].variation=w,$('#a'+(g+' #pv0')).html(w.join(' '))}}}}goInfinite(){'sf9'==engineStatus[this.n].name||'lozza'==engineStatus[this.n].name?(Vars.analyzing=!0,'sf9'==engineStatus[this.n].name&&this.engine.postMessage('setoption name Clear Hash'),this.engine.postMessage('ucinewgame'),engineStatus[this.n].pos=Vars.pos.substring(0,Vars.pos.length-4),this.engine.postMessage('position fen '+Vars.pos),this.engine.postMessage('go infinite')):'tomitank'==engineStatus[this.n].name?(Vars.analyzing=!0,this.engine.postMessage('ucinewgame'),this.engine.postMessage('position fen '+Vars.pos),this.engine.postMessage('go depth 99')):'garbochess'==engineStatus[this.n].name&&(Vars.analyzing=!0,Vars.date=Date.now(),this.engine.postMessage('go'),this.engine.postMessage('position '+Vars.pos),this.engine.postMessage('analyze'))}goDepth(r){('sf9'==engineStatus[this.n].name||'lozza'==engineStatus[this.n].name||'tomitank'==engineStatus[this.n].name)&&('sf9'==engineStatus[this.n].name&&this.engine.postMessage('setoption name Clear Hash'),this.engine.postMessage('ucinewgame'),engineStatus[this.n].pos=Vars.pos,this.engine.postMessage('position fen '+Vars.pos),this.engine.postMessage('go depth '+(r+'')))}goNodes(r){('sf9'==engineStatus[this.n].name||'lozza'==engineStatus[this.n].name)&&('sf9'==engineStatus[this.n].name&&this.engine.postMessage('setoption name Clear Hash'),this.engine.postMessage('ucinewgame'),engineStatus[this.n].pos=Vars.pos,this.engine.postMessage('position fen '+Vars.pos),this.engine.postMessage('go nodes '+(r+'')))}goTime(r){'sf9'==engineStatus[this.n].name||'lozza'==engineStatus[this.n].name||'tomitank'==engineStatus[this.n].name?('sf9'==engineStatus[this.n].name&&this.engine.postMessage('setoption name Clear Hash'),this.engine.postMessage('ucinewgame'),engineStatus[this.n].pos=Vars.pos,this.engine.postMessage('position fen '+Vars.pos),this.engine.postMessage('go movetime '+(1e3*r+''))):'garbochess'==engineStatus[this.n].name&&(Vars.date=Date.now(),this.engine.postMessage('go'),this.engine.postMessage('position '+Vars.pos),this.engine.postMessage('search '+(1e3*r+'')))}stopEngine(){this.engine.terminate(),Vars.analyzing=!1,engineStatus[this.n].status='terminated'}setLines(r){this.engine.postMessage('setoption name MultiPV value '+(r+'')),engineStatus[this.n].multipv=r,$('#a'+(this.n+'')+' #moves').empty();for(var u=0;u<engineStatus[this.n].multipv;u++)$('<div class=\'row\'><div class=\'col-2\' id=\'cp'+u+'\'></div><div class=\'col-10\' id=\'pv'+u+'\' style=\'border: 1px solid green;\'></div></div>').appendTo('#a'+(this.n+'')+' #moves')}}class Move{constructor(r={}){this.id=r.id||Date.now(),this.parent=r.parent,this.moveIdx=r.moveIdx||0,this.san=r.san||'',this.comment=r.comment||'',this.moveVal=r.moveVal||'',this.posVal=r.posVal||'','undefined'==typeof r.nextMove?this.nextMove=[]:(this.nextMove=[],r.nextMove.forEach(u=>{this.nextMove.push(new Move(u))}))}setSan(r){this.san=r}setAttrs(r){this.comment=r.comment,this.moveVal=r.moveVal,this.posVal=r.posVal}appendMove(r){'undefined'==typeof this.nextMove?this.nextMove=Array(r):this.nextMove.push(r)}}class Game{constructor(r={}){this.id=r.id||Date.now(),this.white=r.white||'',this.black=r.black||'',this.whiteElo=r.whiteElo||1100,this.blackElo=r.blackElo||1100,this.result=r.result||'*',this.date=r.date||'',this.round=r.round||'',this.event=r.event||'',this.site=r.site||'',this.eco=r.eco||'',this.annotator=r.annotator||'',this.moveTree=void 0==r.moveTree?void 0:new Move(r.moveTree),this.startpos=r.startpos||'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1'}changeInfo(r={}){this.white=r.white||this.white,this.black=r.black||this.black,this.whiteElo=r.whiteElo||this.whiteElo,this.blackElo=r.blackElo||this.blackElo,this.result=r.result||this.result,this.date=r.date||this.date,this.round=r.round||this.round,this.event=r.event||this.event,this.site=r.site||this.site,this.annotator=r.annotator||this.annotator}addFirstMove(r){this.moveTree=r}gameEmpty(){return this.moveTree==void 0}findMove(r,u=this.moveTree){if(u.id==r)return u;if(0<u.nextMove.length){for(var g,v=0;v<u.nextMove.length;v++)if(g=this.findMove(r,u.nextMove[v]),void 0!=g)return g}}parentMove(r){return this.findMove(r.parent)}childMove(r){if(0!=r.nextMove.length){if(1==r.nextMove.length)return r.nextMove[0];var u='Select variation: ';r.nextMove.forEach((g,f)=>{u+=f+': '+g.san+', '});var v=window.prompt(u,0);return parseInt(v)<r.nextMove.length?r.nextMove[parseInt(v)]:r.nextMove[0]}}deleteMove(r){var u=this.parentMove(r);if('undefined'==typeof u)return r;if(1==u.nextMove.length)u.nextMove=[];else for(var v=0;v<u.nextMove.length;v++)if(u.nextMove[v].id==r.id){u.nextMove.splice(v,1);break}return u}}class Database{constructor(r={}){this.id=r.id||Date.now(),this.name=r.name||'new Database','undefined'==typeof r.games?this.games=[]:(this.games=[],r.games.forEach(u=>{this.games.push(new Game(u))})),this.selected=r.selected||[]}setName(r){this.name=r}addGame(r){'undefined'==typeof this.games?this.games=[r]:this.games.push(r)}overwrite(r){if('undefined'==typeof this.games)this.addGame(r);else{var u=this.games.findIndex(v=>{return v.id==r.id});-1==u?(this.addGame(r),console.log('Nothing to overwrite. Saving game.')):this.games.splice(u,1,r)}}selectAll(){this.selected=[];for(var r=0;r<this.games.length;r++)this.selected.push(this.games[r].id+'')}deselectAll(){this.selected=[]}toggle(r){-1==this.selected.indexOf(r)?this.selected.push(r):this.selected.splice(this.selected.indexOf(r),1),console.log(this.selected)}load(r){for(var u=0;u<this.games.length;u++)r==this.games[u].id&&(Vars.currGame=this.games[u],Vars.changeBoard({position:Vars.currGame.startpos,onDragStart:onDragStart,onDrop:onDrop,onSnapEnd:onSnapEnd}))}}var initdb,initcurrDb;null==localStorage.getItem('db')||''?initdb=[new Database]:(initdb=localStorage.getItem('db').split('\xA7'),initdb=initdb.map(r=>{return JSON.retrocycle(JSON.parse(r))}),initdb=initdb.map(r=>{return new Database(r)}));var Vars={db:initdb,currMove:void 0,currGame:new Game,currDb:initdb[0],pos:'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',analyzing:!1,activeEngines:0,date:Date.now(),initBoard:{position:'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',orientation:'white',showNotation:!0,draggable:!0,dropOffBoard:'snapback',pieceTheme:'img/chesspieces/wikipedia/{piece}.png',moveSpeed:200,snapbackSpeed:'fast',snapSpeed:'fast',trashSpeed:50,sparePieces:!1,onDragStart:onDragStart,onDrop:onDrop,onSnapEnd:onSnapEnd},changeBoard:function(r={}){board.destroy,Vars.initBoard={position:r.position||Vars.pos,orientation:r.orientation||'white',showNotation:r.showNotation||!0,draggable:r.draggable||!0,dropOffBoard:r.dropOffBoard||'snapback',pieceTheme:r.pieceTheme||'img/chesspieces/wikipedia/{piece}.png',moveSpeed:r.moveSpeed||200,snapbackSpeed:r.snapbackSpeed||'fast',snapSpeed:r.snapSpeed||'fast',trashSpeed:r.trashSpeed||50,sparePieces:r.sparePieces||!1,onDragStart:r.onDragStart,onDrop:r.onDrop,onSnapEnd:r.onSnapEnd},board=ChessBoard('board',Vars.initBoard),$(window).resize(board.resize)}};0==Vars.db.length&&Vars.db.push(Vars.currDb);var Modal={view:function(r){return m('.modal.fade',{id:r.attrs.id,role:'dialog'},m('.modal-dialog',{class:r.attrs.size,role:'document'},m('.modal-content',[m('.modal-header',r.attrs.header_hidden?{hidden:!0}:r.attrs.header()),m('.modal-body',r.attrs.body_hidden?{hidden:!0}:r.attrs.body()),m('.modal-footer',r.attrs.footer_hidden?{hidden:!0}:r.attrs.footer())])))}},Upload={oninit:function(r){r.state.id='modalupload',r.state.size='modal-lg',r.state.hideModal=function(){$('#'+r.state.id).modal('hide')},r.state.header=function(){return m('div','Upload pgn')},r.state.body=function(){return m('.container-fluid',[m('.row',m('.col',m('form.form-inline',[m('.input-group',m('.custom-file',[m('label.custom-file-label[for=\'file\'][id=\'filename\']','Choose file'),m('input.custom-file-input[id=\'file\'][type=\'file\']',{onchange:function(){$('#filename').text('undefined'==typeof document.getElementById('file').files[0]?'Choose file':document.getElementById('file').files[0].name)}})])),m('.input-group',[m('.input-group-prepend',m('span.input-group-text','Strip comments')),m('.input-group-append',m('.input-group-text',m('input[aria-label=\'strip comments\'][id=\'comments\'][type=\'checkbox\'][checked=\'checked\']')))]),m('.input-group',[m('.input-group-prepend',m('span.input-group-text','Strip variations')),m('.input-group-append',m('.input-group-text',m('input[aria-label=\'strip variations\'][id=\'variations\'][type=\'checkbox\'][checked=\'checked\']')))])]))),m('hr'),m('.row',m('.col',m('.progress.mb-3',[m('.progress-bar[aria-valuemax=\'100\'][aria-valuemin=\'0\'][aria-valuenow=\'0\'][id=\'progressgame\'][role=\'progressbar\']'),m('div[id=\'progressgameval\']','0%')]))),m('.row',m('.col',m('.progress',[m('.progress-bar[aria-valuemax=\'100\'][aria-valuemin=\'0\'][aria-valuenow=\'0\'][id=\'progressall\'][role=\'progressbar\']',{style:{width:'0%'}}),m('div[id=\'progressallval\']')])))])},r.state.footer=function(){return m('div',[m('button.btn.btn-danger',{onclick:r.state.hideModal},'Close'),m('button.btn.btn-success',{onclick:importGames},'Upload')])}},onupdate:function(){$('#filename').text('undefined'==typeof document.getElementById('file').files[0]?'Choose file':document.getElementById('file').files[0].name)},view:function(r){return m(Modal,{id:r.state.id,size:r.state.size,header:r.state.header,body:r.state.body,footer:r.state.footer,header_hidden:!1,body_hidden:!1,footer_hidden:!1})}},moveAttrs={oninit:function(r){r.state.id='modal1',r.state.size='modal-lg',r.state.hideModal=function(){$('#'+r.state.id).modal('hide')},r.state.header=function(){if('undefined'!=typeof Vars.currMove){var u=parseInt(1+Math.floor(Vars.currMove.moveIdx/2)),v=1==Vars.currMove.moveIdx%2?u+'. '+Vars.currMove.san:u-1+''+'... '+Vars.currMove.san;return m('div','Change Move Attributes for move '+v)}return m('div','no move')},r.state.changeAttrs=function(){Vars.currMove.setAttrs({comment:$('#comment').val(),moveVal:$('#moveval option:selected').val(),posVal:$('#posval option:selected').val()}),$('#'+r.state.id).modal('hide')},r.state.body=function(){return'undefined'==typeof Vars.currMove?m('span','Not available.'):m('form',[m('.form-group.form-row',[m('label[for=\'comment\']','Comment'),m('textarea.form-control[id=\'comment\'][rows=\'3\']',Vars.currMove.comment)]),m('.form-row',[m('.form-group.col',[m('label[for=\'moveval\']','Move Attribute'),m('select.form-control[id=\'moveval\']',[m('option[value=\'!!\']',{selected:'!!'==Vars.currMove.moveVal},'!! (Brilliant move)'),m('option[value=\'!\']',{selected:'!'==Vars.currMove.moveVal},'! (Strong move)'),m('option[value=\'!?\']',{selected:'!?'==Vars.currMove.moveVal},'!? (Interesting move)'),m('option[value=\'?!\']',{selected:'?!'==Vars.currMove.moveVal},'?! (Questionable move)'),m('option[value=\'?\']',{selected:'?'==Vars.currMove.moveVal},'? (Mistake)'),m('option[value=\'??\']',{selected:'??'==Vars.currMove.moveVal},'?? (Blunder)'),m('option[value=\'&#x25A1;\']',{selected:'&#x25A1;'==Vars.currMove.moveVal},[m.trust('&#x25A1;'),' (Only move)']),m('option[value=\'\']',{selected:''==Vars.currMove.moveVal},'(None)')])]),m('.form-group.col',[m('label[for=\'posval\']','Position Attribute'),m('select.form-control[id=\'posval\']',{selected:'&#xFF0D;'==Vars.currMove.posVal},[m('option[value=\'+&#xFF0D;\']',['+',m.trust('&#xFF0D;'),' (White wins)']),m('option[value=\'&#xB1;\']',{selected:'&#xB1;'==Vars.currMove.posVal},[m.trust('&#xB1;'),' (Advantage for white)']),m('option[value=\'&#x2A72;\']',{selected:'&#x2A72;'==Vars.currMove.posVal},[m.trust('&#x2A72;'),' (Small advantage for white)']),m('option[value=\'=\']',{selected:'='==Vars.currMove.posVal},'= (Equal position)'),m('option[value=\'&#x2A71;\']',{selected:'&#x2A71;'==Vars.currMove.posVal},[m.trust('&#x2A71;'),' (Small advantage for black)']),m('option[value=\'&#x2213;\']',{selected:'&#x2213;'==Vars.currMove.posVal},[m.trust('&#x2213;'),'  (Advantage for black)']),m('option[value=\'&#xFF0D;+\']',{selected:'&#xFF0D;'==Vars.currMove.posVal},[m.trust('&#xFF0D;'),'+ (Black wins)']),m('option[value=\'&#x221E;\']',{selected:'&#x221E;'==Vars.currMove.posVal},[m.trust('&#x221E;'),' (Unclear position)']),m('option[value=\'=/&#x221E;\']',{selected:'&#x221E;'==Vars.currMove.posVal},['=/',m.trust('&#x221E;'),' (Compensation)']),m('option[value=\'&#x2191;\']',{selected:'&#x2191;'==Vars.currMove.posVal},[m.trust('&#x2191;'),' (Initiative)']),m('option[value=\'\']',{selected:''==Vars.currMove.posVal},'(None)')])])])])},r.state.footer=function(){return m('div',[m('button.btn.btn-danger',{onclick:r.state.hideModal},'Cancel'),m('button.btn.btn-success',{onclick:r.state.changeAttrs},'Save')])}},view:function(r){return m(Modal,{id:r.state.id,size:r.state.size,header:r.state.header,body:r.state.body,footer:r.state.footer,header_hidden:!1,body_hidden:!1,footer_hidden:!1})}},saveDialog={oninit:function(r){r.state.id=r.attrs.id,r.state.size='modal-lg',r.state.hideModal=function(){$('#'+r.state.id).modal('hide')},r.state.header=function(){return m('div','Enter game information to be saved')},r.state.footer=function(){return m('.form-group.form-inline',[m('button.btn.btn-danger',{onclick:r.state.hideModal},'Cancel'),m('.input-group',[m('.input-group-prepend',m('button.btn.btn-success.ml-2[type=\'button\']',{onclick:r.attrs.saveChanges},r.attrs.btnText)),m('select.form-control',{id:'selectDb'+r.state.id},[Vars.db.map(u=>{return m('option',{value:u.id,selected:!(Vars.currDb.id!=u.id)},u.name)})])])])},r.state.body=function(){return m('form',[m('h4','Personal Information'),m('.form-row',[m('.form-group.col-8',[m('label[for=\'nameWhite\']','Name White'),m('input.form-control[placeholder=\'Mustermann, Max\'][type=\'text\']',{id:'nameWhite'+r.state.id,value:Vars.currGame.white})]),m('.form-group.col-4',[m('label[for=\'eloWhite\']','Elo White'),m('input.form-control[max=\'3500\'][min=\'600\'][type=\'number\'][placeholder=\'1100\']',{id:'eloWhite'+r.state.id,value:Vars.currGame.whiteElo})])]),m('.form-row',[m('.form-group.col-8',[m('label[for=\'nameBlack\']','Name Black'),m('input.form-control[placeholder=\'Doe, John\'][type=\'text\']',{id:'nameBlack'+r.state.id,value:Vars.currGame.black})]),m('.form-group.col-4',[m('label[for=\'eloBlack\']','Elo Black'),m('input.form-control[max=\'3500\'][min=\'600\'][type=\'number\'][placeholder=\'1100\']',{id:'eloBlack'+r.state.id,value:Vars.currGame.blackElo})])]),m('hr'),m('h4','Match Information'),m('.form-row',[m('.form-group.col-6',[m('label[for=\'event\']','Event'),m('input.form-control[placeholder=\'Event Name\'][type=\'text\']',{id:'event'+r.state.id,value:Vars.currGame.event})]),m('.form-group.col-3',[m('label[for=\'round\']','Round'),m('input.form-control[type=\'number\'][value=\'1\'][min=\'1\']',{id:'round'+r.state.id,value:Vars.currGame.round})]),m('.form-group.col-3',[m('label[for=\'date\']','Date'),m('input.form-control[type=\'date\']',{id:'date'+r.state.id,value:Vars.currGame.date})])]),m('.form-row',[m('.form-group.col-6',[m('label[for=\'site\']','Site'),m('input.form-control[placeholder=\'Site\'][type=\'text\']',{id:'site'+r.state.id,value:Vars.currGame.site})]),m('.form-group.col-3',[m('label[for=\'annotator\']','Annotator'),m('input.form-control[placeholder=\'Annotator\'][type=\'text\']',{id:'annotator'+r.state.id,value:Vars.currGame.annotator})]),m('.form-group.col-3',[m('label[for=\'result\']','Result'),m('select.form-control',{id:'result'+r.state.id},[m('option[value=\'*\']',{selected:!('*'!=Vars.currGame.result)},'*'),m('option[value=\'1-0\']',{selected:!('1-0'!=Vars.currGame.result)},'1 - 0'),m('option[value=\'0-1\']',{selected:!('0-1'!=Vars.currGame.result)},'0 - 1'),m('option[value=\'1/2-1/2\']',{selected:!('1/2-1/2'!=Vars.currGame.result)},'1/2 - 1/2')])])])])}},view:function(r){return m(Modal,{id:r.state.id,size:r.state.size,header:r.state.header,body:r.state.body,footer:r.state.footer,header_hidden:!1,body_hidden:!1,footer_hidden:!1})}},overwriteDialog={oninit:function(r){r.state.id='modal3',r.state.btnText='Save in',r.state.overwrite=function(){var u={white:$('#nameWhite'+r.state.id).val(),black:$('#nameBlack'+r.state.id).val(),whiteElo:$('#eloWhite'+r.state.id).val(),blackElo:$('#eloBlack'+r.state.id).val(),result:$('#result'+r.state.id+' option:selected').val(),date:$('#date'+r.state.id).val(),round:$('#round'+r.state.id).val(),event:$('#event'+r.state.id).val(),site:$('#site'+r.state.id).val(),annotator:$('#annotator'+r.state.id).val()};Vars.currGame.changeInfo(u);var v=Vars.db.findIndex(g=>{return g.id==$('#selectDb'+r.state.id+' option:selected').val()});Vars.db[v].overwrite(Vars.currGame),saveEverything(),m.redraw(),$('#modal3').modal('hide')}},view:function(r){return m(saveDialog,{id:r.state.id,saveChanges:r.state.overwrite,btnText:r.state.btnText})}},Pgn={oninit:function(r){r.state.a=[],r.state.selectMove=function(u){Vars.analyzing&&(engine.stopEngine(),Vars.analyzing=!0),Vars.currMove=Vars.currGame.findMove(u);for(var v=Vars.currMove,g=[];v.id!=Vars.currGame.moveTree.id;)g.unshift(v.san),v=Vars.currGame.parentMove(v);g.unshift(v.san),v=Vars.currGame.parentMove(v),c=new Chess(Vars.currGame.startpos),g.forEach(function(f){c.move(f)}),board.position(c.fen()),Vars.pos=c.fen(),Vars.analyzing&&(engine=new Engine({engine:'sf9',number:0}),engine.goInfinite())},r.state.setFen=function(u){var v=new Chess;v.load(u)?(Vars.pos=u,c=new Chess(Vars.pos),Vars.currGame=new Game({startpos:Vars.pos}),board.position(c.fen())):console.log('Invalid fen string')},r.state.formatMove=function(u,v){var g=parseInt(1+Math.floor(u.moveIdx/2)),f=1==u.moveIdx%2?g+'. '+u.san+' ':u.san+' ',b='undefined'==typeof Vars.currMove?'v'+v:u.id==Vars.currMove.id?'selected v'+v:'v'+v;return m('span',{id:u.id,onclick:m.withAttr('id',r.state.selectMove),ondblclick:function(){return $('#modal1').modal('show')},class:b},[m('span',f),''==u.moveVal?null:m('span.moveVal',m.trust(u.moveVal)),''==u.posVal?null:m('span.posVal',m.trust(u.posVal)),''==u.comment?null:m('span.comment',m.trust(u.comment))])},r.state.consumeMoves=function(u,v,g=[],f=!1){f||r.state.a.push(r.state.formatMove(u,v)),0==u.nextMove.length?r.state.a.push(m('br')):1==u.nextMove.length?r.state.consumeMoves(u.nextMove[0],v,g):u.nextMove.forEach((b,h,M)=>{0==h?(r.state.a.push(r.state.formatMove(b,v)),r.state.a.push(m('br'))):h==M.length-1?(r.state.consumeMoves(b,v+1,g),r.state.consumeMoves(M[0],v,g,!0)):r.state.consumeMoves(b,v+1,g)})}},view:function(r){return'undefined'!=typeof Vars.currGame.moveTree&&(r.state.a=[],r.state.consumeMoves(Vars.currGame.moveTree,0)),m('div',[m(overwriteDialog),m('.input-group',[m('.input-group-prepend',m('span.input-group-text','FEN')),m('input#fen.form-control[type=\'text\']',{value:Vars.pos,onchange:m.withAttr('value',r.state.setFen)})]),m('div',[m('span',Vars.currGame.white),m('span','('+Vars.currGame.whiteElo+')'),m('span',' vs. '),m('span',Vars.currGame.black),m('span','('+Vars.currGame.blackElo+')'),m('span',Vars.currGame.result),m('br'),m('span',Vars.currGame.event),m('span','['+Vars.currGame.site+']'),m('span','Round '+Vars.currGame.round),m('span','played on '+Vars.currGame.date),m('br'),m('span','Annotator: '+Vars.currGame.annotator)]),m('div.pgn',['undefined'==typeof Vars.currGame.moveTree?m('div','waiting for moves'):m('div',[m('div','['+Vars.currGame.startpos+']'),m('br'),m(moveAttrs),r.state.a.map(u=>{return u})])]),m('.btn-toolbar[aria-label=\'PGN Toolbar\'][role=\'toolbar\']',[m('.btn-group.mr-1[aria-label=\'Move\'][role=\'group\']',[m('button.btn.btn-secondary[title=\'delete this and following moves\'][type=\'button\']',{onclick:'undefined'==typeof Vars.currGame.moveTree?'':undo},m.trust('&#x21E4;')),m('button.btn.btn-secondary[title=\'move back\'][type=\'button\']',{onclick:'undefined'==typeof Vars.currGame.moveTree?'':back},m('strong',m.trust('&#x2190;'))),m('button.btn.btn-secondary[title=\'move forward\'][type=\'button\']',{onclick:'undefined'==typeof Vars.currGame.moveTree?'':forward},m('strong',m.trust('&#x2192;'))),m('button.btn.btn-secondary[title=\'promote variation\'][type=\'button\']',{onclick:'undefined'==typeof Vars.currGame.moveTree?'':promote},m.trust('&#x2B06;')),m('button.btn.btn-secondary[title=\'delete variation\'][type=\'button\']',{onclick:'undefined'==typeof Vars.currGame.moveTree?'':deleteVariation},m.trust('&#x274E;'))]),m('.btn-group[aria-label=\'Game\'][role=\'group\']',[m('button.btn.btn-secondary[title=\'new game\'][type=\'button\']',{onclick:newgame},m.trust('&#x25A9;')),m('button#fromBoard.btn.btn-secondary[title=\'set up board\'][type=\'button\']',{onclick:fromboard},m.trust('&#x265E;')),m('button.btn.btn-secondary[title=\'save\'][type=\'button\']',{onclick:function(){return $('#modal3').modal('show')}},[m('span',m.trust('&#x1F5AB;'))])])])])}},Db={oninit:function(r){r.state.selectDb=function(){var u=Vars.db.findIndex(v=>{return v.id==$('#chooseDb option:selected').val()});Vars.currDb=Vars.db[u]},r.state.toggleGame=function(u){Vars.currDb.toggle(u),saveEverything()},r.state.loadGame=function(u){Vars.currDb.load(u)},r.state.renameDatabase=function(){var u=window.prompt('Choose a name for the current database.','New Database');Vars.currDb.setName(u),saveEverything()},r.state.newDatabase=function(){var u=window.prompt('Choose a name for the new database.','New Database');Vars.db.push(new Database({name:u})),saveEverything()},r.state.deleteDatabase=function(){if(0==Vars.db.length)console.log('Nothing to delete.');else if(1==Vars.db.length)Vars.db=[],saveEverything();else{var u=Vars.db.findIndex(v=>{return v.id==Vars.currDb.id});Vars.db.splice(u,1),Vars.currDb=Vars.db[u-1]||new Database,saveEverything()}},r.state.selectAllGames=function(){Vars.currDb.selectAll(),saveEverything()},r.state.deselectAllGames=function(){Vars.currDb.deselectAll(),saveEverything()},r.state.deleteGames=function(){console.log('deleting'),Vars.currDb.games=Vars.currDb.games.filter(u=>{return-1==Vars.currDb.selected.indexOf(u.id+'')}),Vars.currDb.selected=[],saveEverything()},r.state.copyTo=function(){var u='Type number of Database you want to copy selected games to!\n';Vars.db.forEach((g,f)=>{u+=f+''+': '+g.name+'\n'});var v=window.prompt(u,0);Vars.currDb.games.forEach(g=>{if(-1!=Vars.currDb.selected.indexOf(g.id+'')){var f=JSON.parse(JSON.stringify(g));f.id=Date.now(),Vars.db[v].addGame(new Game(f))}}),saveEverything()},r.state.moveTo=function(){r.state.copyTo(),r.state.deleteGames()},r.state.a=[],r.state.formatMove=function(u){var g=parseInt(1+Math.floor(u.moveIdx/2)),f=1==u.moveIdx%2?g+'. '+u.san+' ':u.san+' ';return''==u.moveVal&&''==u.posVal&&''==u.comment?f:(f+=`{${u.moveVal}|${u.posVal}|${u.comment}} `,f)},r.state.consumeMoves=function(u,v,g=[],f=!1){f||r.state.a.push(r.state.formatMove(u,v)),'undefined'==typeof u.nextMove||(1==u.nextMove.length?r.state.consumeMoves(u.nextMove[0],v,g):u.nextMove.forEach((b,h,M)=>{0==h?r.state.a.push(r.state.formatMove(b,v)):h==M.length-1?(r.state.a.push('( '),r.state.consumeMoves(b,v+1,g),r.state.a.push(') '),r.state.consumeMoves(M[0],v,g,!0)):(r.state.a.push('( '),r.state.consumeMoves(b,v+1,g),r.state.a.push(') '))}))},r.state.exportGame=function(){var v='';Vars.currDb.games.forEach((h,M,y)=>{-1!=Vars.currDb.selected.indexOf(h.id+'')&&(v+=`[Event "${''==h.event?'?':h.event}"]\n`,v+=`[Site "${''==h.site?'?':h.site}"]\n`,v+=`[Date "${''==h.date?'?':h.date}"]\n`,v+=`[Round "${''==h.round?'?':h.round}"]\n`,v+=`[White "${''==h.white?'?':h.white}"]\n`,v+=`[Black "${''==h.black?'?':h.black}"]\n`,v+=`[Result "${h.result}"]\n`,v+=`[WhiteElo "${''==h.whiteElo?'?':h.whiteElo}"]\n`,v+=`[BlackElo "${''==h.blackElo?'?':h.blackElo}"]\n`,v+=`[Annotator "${''==h.annotator?'?':h.annotator}"]\n`,v+=`[ECO "${''==h.eco?'?':h.eco}"]\n`,v+=`[FEN "${h.startpos}"]\n\n`,r.state.a=[],r.state.consumeMoves(h.moveTree,0),v+=r.state.a.join(''),v+=`${h.result}`,M!=y.length-1&&(v+=`\n\n`))});var g=new Blob([v],{type:'text/plain;charset=utf-8'}),f=document.createElement('a');document.body.appendChild(f),f.style='display: none';var b=window.URL.createObjectURL(g);f.href=b,f.download='my-games.pgn',f.click(),window.URL.revokeObjectURL(b)},r.state.importGame=function(){}},view:function(r){return m('div',[m(Upload),m('.input-group.mb-2',[m('.input-group-prepend',m('label.input-group-text[for=\'chooseDb\']','Database')),m('select.custom-select[id=\'chooseDb\']',{onchange:r.state.selectDb},[Vars.db.map(u=>{return m('option',{selected:!(u.id!=Vars.currDb.id),value:u.id},u.name)})])]),m('.table-responsive.db-table',m('table.table.table-sm.table-striped',[m('thead.thead-light',m('tr',[m('th[scope=\'col\']','White'),m('th[scope=\'col\']','Black'),m('th[scope=\'col\']','Result'),m('th[scope=\'col\']','Date'),m('th[scope=\'col\']','Moves')])),m('tbody',[Vars.currDb.games.map(u=>{var v=-1==Vars.currDb.selected.indexOf(u.id+'')?'':'selected-game';return m('tr',{class:v},[m('td',{name:u.id,class:v,onclick:m.withAttr('name',r.state.toggleGame),ondblclick:m.withAttr('name',r.state.loadGame)},u.white),m('td',{name:u.id,class:v,onclick:m.withAttr('name',r.state.toggleGame),ondblclick:m.withAttr('name',r.state.loadGame)},u.black),m('td',{name:u.id,class:v,onclick:m.withAttr('name',r.state.toggleGame),ondblclick:m.withAttr('name',r.state.loadGame)},u.result),m('td',{name:u.id,class:v,onclick:m.withAttr('name',r.state.toggleGame),ondblclick:m.withAttr('name',r.state.loadGame)},u.date),m('td',{name:u.id,class:v,onclick:m.withAttr('name',r.state.toggleGame),ondblclick:m.withAttr('name',r.state.loadGame)},'undefined'==typeof u.moveTree?'no moves':'1. '+u.moveTree.san+'...')])})])])),m('.btn-toolbar[aria-label=\'DB Toolbar\'][role=\'toolbar\']',[m('.btn-group.mr-1[aria-label=\'Game\'][role=\'group\']',[m('button.btn.btn-secondary[title=\'delete selected games\'][type=\'button\']',{onclick:r.state.deleteGames},[m('span',m.trust('&#x1F5AB;')),m('sup',m.trust('&#x274C;'))]),m('button.btn.btn-secondary[title=\'import games\'][type=\'button\']',{onclick:function(){$('#modalupload').modal('show')}},[m('span',m.trust('&#x1F5AB;')),m('sup',m.trust('&#x2B06;'))]),m('button.btn.btn-secondary[title=\'export games\'][type=\'button\']',{onclick:r.state.exportGame},[m('span',m.trust('&#x1F5AB;')),m('sup',m.trust('&#x2B07;'))])]),m('.btn-group[aria-label=\'Database\'][role=\'group\']',[m('button.btn.btn-secondary[title=\'rename database\'][type=\'button\']',{onclick:r.state.renameDatabase},[m('span',m.trust('&#x26C1;')),m('sup',m('strong',m.trust('&#x1F5E9;')))]),m('button.btn.btn-secondary[title=\'new database\'][type=\'button\']',{onclick:r.state.newDatabase},[m('span',m.trust('&#x26C1;')),m('sup',m.trust('&#x2795;'))]),m('button.btn.btn-secondary[title=\'delete database\'][type=\'button\']',{onclick:r.state.deleteDatabase},[m('span',m.trust('&#x26C1;')),m('sup',m.trust('&#x274C;'))]),m('button.btn.btn-secondary[title=\'select all games\'][type=\'button\']',{onclick:r.state.selectAllGames},m('span',m.trust('&#x1F5F9;'))),m('button.btn.btn-secondary[title=\'deselect all games\'][type=\'button\']',{onclick:r.state.deselectAllGames},m('span',m.trust('&#x2610;'))),m('button.btn.btn-secondary[title=\'copy to\'][type=\'button\']',{onclick:r.state.copyTo},m('span',m.trust('&#x1F5D0;'))),m('button.btn.btn-secondary[title=\'move to\'][type=\'button\']',{onclick:r.state.moveTo},m('span',m.trust('&#x2398;')))])])])}},Analysis={oninit:function(r){r.state.num=r.attrs.num,engine=new Engine({engine:'sf9',number:r.state.num}),r.state.engine=engine,r.state.infinite=function(){r.state.engine.goInfinite()},r.state.stop=function(){r.state.engine.stopEngine(),engine=new Engine({engine:$('#chooseEngine option:selected').val(),number:r.state.num}),r.state.engine=engine},r.state.action=function(){var u=$('#a'+(r.state.num+'')+' #chooseAnalysis option:selected').val();'depth'==u?r.state.engine.goDepth($('#a'+(r.state.num+'')+' #num').val()):'time'==u?r.state.engine.goTime($('#a'+(r.state.num+'')+' #num').val()):'nodes'==u?r.state.engine.goNodes($('#a'+(r.state.num+'')+' #num').val()):'setlines'==u&&r.state.engine.setLines($('#a'+(r.state.num+'')+' #num').val())},r.state.changeEngine=function(){var u=$('#chooseEngine option:selected').val();!0==Vars.analyzing?(r.state.engine.stopEngine(),engine=new Engine({engine:u,number:r.state.num}),r.state.engine=engine,r.state.engine.goInfinite()):(r.state.engine.stopEngine(),engine=new Engine({engine:u,number:r.state.num}),r.state.engine=engine)}},view:function(r){return m('div',{id:'a'+(r.state.num+'')},[m('.row.mb-1',m('.col',m('form.form-inline',[m('.input-group.input-group-sm',[m('select.custom-select[id=\'chooseEngine\']',{onchange:r.state.changeEngine},[m('option[value=\'sf9\']','Stockfish 9'),m('option[value=\'lozza\']','Lozza'),m('option[value=\'tomitank\']','Tomitank'),m('option[value=\'garbochess\']','Garbochess')]),m('.input-group-append.mr-1',[m('button.btn.btn-primary[type=\'button\']',{onclick:r.state.infinite},'Go Infinite'),m('button.btn.btn-danger[type=\'button\']',{onclick:r.state.stop},'Stop')])]),m('.input-group.input-group-sm',[m('.input-group-prepend',m('button.btn.btn-warning[type=\'button\']',{onclick:r.state.action},'Go')),m('select.custom-select[id=\'chooseAnalysis\']',[m('option[value=\'depth\']',{disabled:!('garbochess'!=$('#chooseEngine option:selected').val())},'depth'),m('option[value=\'time\']',{selected:!('garbochess'!=$('#chooseEngine option:selected').val())},'time'),m('option[value=\'nodes\']',{disabled:!('garbochess'!=$('#chooseEngine option:selected').val())},'nodes'),m('option[value=\'\u2014\u2014\u2014\u2014\u2014\u2014\u2014\'][disabled=\'disabled\']','\u2014\u2014\u2014\u2014\u2014\u2014\u2014'),m('option[value=\'setlines\']',{disabled:'garbochess'==$('#chooseEngine option:selected').val()||'lozza'==$('#chooseEngine option:selected').val()||'tomitank'==$('#chooseEngine option:selected').val()},'# of variations')]),m('input[id=\'num\'][placeholder=\'0\'][type=\'number\']',{style:{width:'5em'}})])]))),m('.row',[m('.col-3',m('div',{id:'analysisBoard'+r.state.num},'Analysis Board to be displayed')),m('.col-9',[m('.row.mb-2',[m('.col[data-placement=\'top\'][data-toggle=\'tooltip\'][title=\'million searched nodes\']',[m('span','MNodes '),m('span#nodes')]),m('.col[data-placement=\'top\'][data-toggle=\'tooltip\'][title=\'thousand searched nodes per second\']',[m('span','kNodes/s '),m('span#nps')]),m('.col[data-placement=\'top\'][data-toggle=\'tooltip\'][title=\'time spent for search\']',[m('span','sec '),m('span#time')]),m('.col[data-placement=\'top\'][data-toggle=\'tooltip\'][title=\'number of searched plies\']',[m('span','depth '),m('span#depth')])]),m('#moves',m('.row',m('.col-2#cp0'),m('.col-10#pv0[style=\'border: 1px solid green;\']')))])])])}},board=ChessBoard('board',Vars.initBoard);$(window).resize(board.resize);var undo=function(){Vars.analyzing&&(engine.stopEngine(),Vars.analyzing=!0),Vars.currMove=Vars.currGame.deleteMove(Vars.currMove),c.undo(),board.position(c.fen()),Vars.pos=c.fen(),Vars.analyzing&&(engine=new Engine({engine:'sf9',number:0}),engine.goInfinite()),m.redraw()},back=function(){(Vars.analyzing&&(engine.stopEngine(),Vars.analyzing=!0),void 0!=Vars.currGame.parentMove(Vars.currMove))&&(Vars.currMove=Vars.currGame.parentMove(Vars.currMove),c.undo(),board.position(c.fen()),Vars.pos=c.fen(),Vars.analyzing&&(engine=new Engine({engine:'sf9',number:0}),engine.goInfinite()),m.redraw())},forward=function(){(Vars.analyzing&&(engine.stopEngine(),Vars.analyzing=!0),0!=Vars.currMove.nextMove.length)&&(Vars.currMove=Vars.currGame.childMove(Vars.currMove),c.move(Vars.currMove.san),board.position(c.fen()),Vars.pos=c.fen(),Vars.analyzing&&(engine=new Engine({engine:'sf9',number:0}),engine.goInfinite()),m.redraw())},newgame=function(){Vars.analyzing&&(engine.stopEngine(),Vars.analyzing=!0),Vars.currGame=new Game,board.position('start'),c=new Chess,Vars.pos=c.fen(),Vars.analyzing&&(engine=new Engine({engine:'sf9',number:0}),engine.goInfinite()),m.redraw()},fromboard=function(){if($('#fromBoard').toggleClass('active'),$('#fromBoard').hasClass('active'))Vars.changeBoard({position:'clear',draggable:!0,dropOffBoard:'trash',trashSpeed:50,sparePieces:!0});else{var r=board.position('fen')+'';r+=' w - - 0 1',console.log(r),Vars.changeBoard({position:r,dropOffBoard:'snapback',pieceTheme:'img/chesspieces/wikipedia/{piece}.png',moveSpeed:200,snapbackSpeed:'fast',snapSpeed:'fast',trashSpeed:50,sparePieces:!1,onDragStart:onDragStart,onDrop:onDrop,onSnapEnd:onSnapEnd}),c=new Chess(r),Vars.pos=r,Vars.currGame=new Game({startpos:r}),m.redraw()}},deleteVariation=function(){for(;Vars.currGame.parentMove(Vars.currMove).nextMove[0]==Vars.currMove;)Vars.currMove=Vars.currGame.deleteMove(Vars.currMove),c.undo();Vars.currMove=Vars.currGame.deleteMove(Vars.currMove),c.undo(),board.position(c.fen()),Vars.pos=c.fen()},promote=function(){for(;Vars.currGame.parentMove(Vars.currMove).nextMove[0]==Vars.currMove;)Vars.currMove=Vars.currGame.parentMove(Vars.currMove);var r=Vars.currMove;Vars.currMove=Vars.currGame.parentMove(Vars.currMove);for(var u=0;u<Vars.currMove.nextMove.length;u++)if(Vars.currMove.nextMove[u].id==r.id){var v=Vars.currMove.nextMove[0];Vars.currMove.nextMove[0]=r,Vars.currMove.nextMove[u]=v,Vars.currMove=Vars.currMove.nextMove[0];break}},importGames=function(){var r,v=document.getElementById('file').files[0];v||console.log('No file selected.');var g=new FileReader;g.onload=function(){r=g.result;var b=r.replace(/\r/gm,'').replace(/>/gm,'').replace(/</gm,'').split('\n'),h,M='',y=Date.now(),w=$('#comments').prop('checked'),G=$('#variations').prop('checked');b.forEach((E,D,B)=>{if($('#progressall').css('width',Math.floor(100*(D/B.length))+'%'),console.log(100*(D/B.length)+'%'),/^\[.*\]$/.test(E)&&(0>D-1||!/^\[.*\]$/.test(B[D-1]))&&('undefined'!=typeof h&&Vars.currDb.addGame(h),h=new Game({id:y+D})),/^\[Event \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.event=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[Site \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.site=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[Date \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,'').replace(/-/g,'.'),h.date=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[Round \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.round=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[White \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.white=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[Black \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.black=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[Result \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.result=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[Annotator \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.annotator=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[[Ee]loWhite \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.eloWhite=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[[Ee]loBlack \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.eloBlack=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[[Ee][Cc][Oo] \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.eco=I,$('#text').append(D+': '+I+'<br>')}else if(/^\[FEN \".*\"\]$/.test(E)){var I=E.match(/\".*\"/)+'';I=I.replace(/\"/g,''),h.startpos=I,$('#text').append(D+': '+I+'<br>')}else if(/^ ?1\.[^\.\}]{2}((?!1\-0|0\-1|\*|1\/2\-1\/2|0\.5\-0\.5|0,5\-0,5)[^\}])*$/.test(E.replace(/\{[^\{\}]*?\}/g,''))){M='',M+=E+'';for(var z=D;!/^(?:(?!\{(?!.*\})).)*(1\-0|0\-1|\*|1\/2\-1\/2)$/.test(B[z+1]+'');)M+=' '+(B[z+1]+''),++z;M+=' '+(B[z+1]+''),$('#text').append(D+': '+M+'<br>')}else /^1\..+[1\-0|0\-1|\*|1\/2\-1\/2]$/.test(E)?(M=(E+'').replace(/\"/g,''),$('#text').append(D+': '+M+'<br>')):''==E+''&&$('#text').append(D+': new line<br>');if(''!=M)if(M=M.replace(/\(/gm,' ( ').replace(/\)/gm,' ) ').replace(/\{/gm,' { ').replace(/\}/gm,' } '),console.log('raw tmpmoves: '+M),console.log(w,G),!w&&!G){var P=M.split(' ');P=P.filter(R=>{return''!=R});var A,S;for(console.log(P),S=''==h.startpos?new Chess:new Chess(h.startpos),k=0;k<P.length;k++)if(console.log(k),null!=S.move(P[k],{sloppy:!0})){console.log('move...');var V=S.history();if(h.gameEmpty()){console.log('add first move');var T=new Move({id:y+k,parent:y+k,san:V[V.length-1],moveIdx:V.length});h.addFirstMove(T),A=T}else{var T=new Move({id:y+k,san:V[V.length-1],parent:A.id,moveIdx:V.length});0==A.nextMove.length?(console.log('add move to main line'),A.appendMove(T),A=T):void 0===A.nextMove.find(R=>{return R.san==T.san})?(console.log('add new variation'),A.appendMove(T),A=T):A=A.nextMove.find(R=>{return R.san==T.san})}}else if('('==P[k])console.log('prepare to add variation, set 1 back'),A=h.parentMove(A),S.undo();else if(')'==P[k]){for(console.log('end variation, got to root then play one');h.parentMove(A).nextMove[0]==A;)A=h.parentMove(A),S.undo();A=h.parentMove(A),S.undo(),A=A.nextMove[0],S.move(A.san)}else if('{'==P[k]){console.log('start comment');for(var N=k,C='';'}'!=P[N];)C+=' '+P[N],N+=1;console.log('end comment'),C+=' '+P[N+1],'undefined'==typeof A||A.setAttrs({comment:C.replace(/\{/,'').replace(/\}/,'')}),k=N}M='',console.log(h)}else if(w&&G){try{for(var F=0;/\{/.test(M);){if(F+=1,15==F)throw'cannot strip comments';M=M.replace(/\{([^\{\}]+)\}/g,'')}for(F=0;/\(/.test(M);){if(F+=1,15==F)throw'cannot strip variations';M=M.replace(/\(([^\(\)]+)\)/g,'')}var P=M.split(' ');P=P.filter(R=>{return''!=R});var A,S;for(console.log(P),S=''==h.startpos?new Chess:new Chess(h.startpos),k=0;k<P.length;k++)if(console.log(k),null!=S.move(P[k],{sloppy:!0})){console.log('move...');var V=S.history();if(h.gameEmpty()){console.log('add first move');var T=new Move({id:y+k,parent:y+k,san:V[V.length-1],moveIdx:V.length});h.addFirstMove(T),A=T}else{var T=new Move({id:y+k,san:V[V.length-1],parent:A.id,moveIdx:V.length});A.appendMove(T),A=T}}}catch(R){console.log(R)}M='',console.log(h)}}),Vars.currDb.addGame(h)},g.readAsText(v,'ISO-8859-15'),m.redraw()};$(window).on('load',function(){m.mount(document.getElementById('pgn'),Pgn),m.mount(document.getElementById('dbs'),Db),m.mount(document.getElementById('ana1'),{view:function(){return m(Analysis,{num:Vars.activeEngines})}}),Vars.activeEngines+=1}),$(window).on('beforeunload',saveEverything);